<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Open Autonomous Runtime â€” v3.2</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#07080c;--surface:#0f1219;--surface-2:#171b25;--border:#262c3c;--border-accent:#384058;
    --text:#dfe2ea;--text-dim:#7a8099;--text-muted:#4a5068;
    --blue:#4d8bff;--cyan:#22d3ee;--green:#34d399;--amber:#fbbf24;--red:#f87171;
    --purple:#a78bfa;--pink:#f472b6;--orange:#fb923c;--lime:#a3e635;--teal:#2dd4bf;
    --sky:#38bdf8;--gold:#e8b931;--indigo:#818cf8;--rose:#fb7185;--emerald:#10b981;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;}
  .canvas{max-width:1440px;margin:0 auto;padding:36px 22px 80px;}

  .header{text-align:center;margin-bottom:32px;}
  .badge{display:inline-block;font-family:'JetBrains Mono',monospace;font-size:8.5px;font-weight:600;text-transform:uppercase;letter-spacing:1.8px;padding:4px 13px;border-radius:3px;margin-bottom:10px;color:var(--gold);border:1px solid rgba(232,185,49,0.35);background:rgba(232,185,49,0.06);}
  .header h1{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:22px;letter-spacing:-0.5px;margin-bottom:7px;}
  .header h1 .hl{color:var(--cyan);} .header h1 .v{color:var(--gold);font-size:14px;}
  .header p{font-size:12px;color:var(--text-dim);max-width:840px;margin:0 auto;line-height:1.65;}
  .changes{margin-top:10px;display:flex;justify-content:center;gap:5px;flex-wrap:wrap;}
  .ch{font-family:'JetBrains Mono',monospace;font-size:8px;padding:2px 7px;border-radius:3px;font-weight:500;}
  .ch.new{background:rgba(232,185,49,0.1);color:var(--gold);border:1px solid rgba(232,185,49,0.2);}
  .ch.kept{background:rgba(255,255,255,0.02);color:var(--text-muted);border:1px solid rgba(255,255,255,0.05);}

  .layer{position:relative;border:1px solid var(--border);border-radius:7px;padding:20px 16px 14px;margin-bottom:12px;background:var(--surface);}
  .layer::before{content:attr(data-label);position:absolute;top:-9px;left:14px;font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;padding:2px 8px;border-radius:3px;background:var(--bg);z-index:2;}

  .l-purple{border-color:rgba(167,139,250,0.3);} .l-purple::before{color:var(--purple);border:1px solid rgba(167,139,250,0.3);}
  .l-orange{border-color:rgba(251,146,60,0.35);} .l-orange::before{color:var(--orange);border:1px solid rgba(251,146,60,0.35);}
  .l-cyan{border-color:rgba(34,211,238,0.3);} .l-cyan::before{color:var(--cyan);border:1px solid rgba(34,211,238,0.3);}
  .l-blue{border-color:rgba(77,139,255,0.3);} .l-blue::before{color:var(--blue);border:1px solid rgba(77,139,255,0.3);}
  .l-red{border-color:rgba(248,113,113,0.35);} .l-red::before{color:var(--red);border:1px solid rgba(248,113,113,0.35);}
  .l-green{border-color:rgba(52,211,153,0.3);} .l-green::before{color:var(--green);border:1px solid rgba(52,211,153,0.3);}
  .l-amber{border-color:rgba(251,191,36,0.3);} .l-amber::before{color:var(--amber);border:1px solid rgba(251,191,36,0.3);}
  .l-lime{border-color:rgba(163,230,53,0.25);} .l-lime::before{color:var(--lime);border:1px solid rgba(163,230,53,0.25);}
  .l-teal{border-color:rgba(45,212,191,0.3);} .l-teal::before{color:var(--teal);border:1px solid rgba(45,212,191,0.3);}
  .l-sky{border-color:rgba(56,189,248,0.3);} .l-sky::before{color:var(--sky);border:1px solid rgba(56,189,248,0.3);}
  .l-gold{border-color:rgba(232,185,49,0.35);} .l-gold::before{color:var(--gold);border:1px solid rgba(232,185,49,0.35);}
  .l-emerald{border-color:rgba(16,185,129,0.35);} .l-emerald::before{color:var(--emerald);border:1px solid rgba(16,185,129,0.35);}
  .l-rose{border-color:rgba(251,113,133,0.3);} .l-rose::before{color:var(--rose);border:1px solid rgba(251,113,133,0.3);}

  .row{display:flex;gap:9px;flex-wrap:wrap;align-items:stretch;}
  .row+.row{margin-top:9px;}
  .box{flex:1;min-width:130px;background:var(--surface-2);border:1px solid var(--border);border-radius:5px;padding:10px 12px;}
  .box .t{font-family:'JetBrains Mono',monospace;font-size:9.5px;font-weight:600;margin-bottom:3px;display:flex;align-items:center;gap:5px;}
  .box .t .ic{width:14px;height:14px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:8px;flex-shrink:0;}
  .box .d{font-size:9.5px;color:var(--text-dim);line-height:1.6;}
  .box .d code{font-family:'JetBrains Mono',monospace;font-size:8.5px;background:rgba(255,255,255,0.06);padding:1px 4px;border-radius:2px;color:var(--text);}

  .b-blue .t{color:var(--blue);} .b-blue .ic{background:rgba(77,139,255,0.14);} .b-blue{border-color:rgba(77,139,255,0.22);}
  .b-cyan .t{color:var(--cyan);} .b-cyan .ic{background:rgba(34,211,238,0.12);} .b-cyan{border-color:rgba(34,211,238,0.18);}
  .b-green .t{color:var(--green);} .b-green .ic{background:rgba(52,211,153,0.12);} .b-green{border-color:rgba(52,211,153,0.18);}
  .b-amber .t{color:var(--amber);} .b-amber .ic{background:rgba(251,191,36,0.12);} .b-amber{border-color:rgba(251,191,36,0.18);}
  .b-red .t{color:var(--red);} .b-red .ic{background:rgba(248,113,113,0.12);} .b-red{border-color:rgba(248,113,113,0.18);}
  .b-purple .t{color:var(--purple);} .b-purple .ic{background:rgba(167,139,250,0.12);} .b-purple{border-color:rgba(167,139,250,0.18);}
  .b-pink .t{color:var(--pink);} .b-pink .ic{background:rgba(244,114,182,0.12);} .b-pink{border-color:rgba(244,114,182,0.18);}
  .b-orange .t{color:var(--orange);} .b-orange .ic{background:rgba(251,146,60,0.12);} .b-orange{border-color:rgba(251,146,60,0.22);}
  .b-lime .t{color:var(--lime);} .b-lime .ic{background:rgba(163,230,53,0.1);} .b-lime{border-color:rgba(163,230,53,0.18);}
  .b-teal .t{color:var(--teal);} .b-teal .ic{background:rgba(45,212,191,0.1);} .b-teal{border-color:rgba(45,212,191,0.18);}
  .b-sky .t{color:var(--sky);} .b-sky .ic{background:rgba(56,189,248,0.1);} .b-sky{border-color:rgba(56,189,248,0.18);}
  .b-gold .t{color:var(--gold);} .b-gold .ic{background:rgba(232,185,49,0.12);} .b-gold{border-color:rgba(232,185,49,0.25);}
  .b-emerald .t{color:var(--emerald);} .b-emerald .ic{background:rgba(16,185,129,0.12);} .b-emerald{border-color:rgba(16,185,129,0.22);}
  .b-rose .t{color:var(--rose);} .b-rose .ic{background:rgba(251,113,133,0.12);} .b-rose{border-color:rgba(251,113,133,0.18);}
  .b-indigo .t{color:var(--indigo);} .b-indigo .ic{background:rgba(129,140,248,0.12);} .b-indigo{border-color:rgba(129,140,248,0.18);}

  .tag{display:inline-block;font-family:'JetBrains Mono',monospace;font-size:7.5px;padding:1px 4px;border-radius:2px;margin-right:2px;font-weight:500;}
  .tag.blue{background:rgba(77,139,255,0.12);color:var(--blue);} .tag.cyan{background:rgba(34,211,238,0.1);color:var(--cyan);}
  .tag.green{background:rgba(52,211,153,0.1);color:var(--green);} .tag.red{background:rgba(248,113,113,0.1);color:var(--red);}
  .tag.amber{background:rgba(251,191,36,0.1);color:var(--amber);} .tag.purple{background:rgba(167,139,250,0.1);color:var(--purple);}
  .tag.orange{background:rgba(251,146,60,0.1);color:var(--orange);} .tag.lime{background:rgba(163,230,53,0.08);color:var(--lime);}
  .tag.gold{background:rgba(232,185,49,0.1);color:var(--gold);} .tag.emerald{background:rgba(16,185,129,0.08);color:var(--emerald);}
  .tag.sky{background:rgba(56,189,248,0.08);color:var(--sky);} .tag.rose{background:rgba(251,113,133,0.08);color:var(--rose);}

  .arrow{display:flex;align-items:center;justify-content:center;height:12px;margin-bottom:12px;font-family:'JetBrains Mono',monospace;font-size:7.5px;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);}
  .arrow .dir{font-size:10px;margin-right:4px;}

  .callout{border:1px dashed var(--border-accent);border-radius:5px;padding:10px 13px;margin-top:8px;background:rgba(255,255,255,0.012);}
  .callout .ct{font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;margin-bottom:3px;}
  .callout .cb{font-size:9.5px;color:var(--text-dim);line-height:1.6;}
  .callout.c-gold .ct{color:var(--gold);} .callout.c-emerald .ct{color:var(--emerald);}
  .callout.c-lime .ct{color:var(--lime);} .callout.c-purple .ct{color:var(--purple);}
  .callout.c-blue .ct{color:var(--blue);} .callout.c-red .ct{color:var(--red);}
  .callout.c-sky .ct{color:var(--sky);} .callout.c-teal .ct{color:var(--teal);}
  .callout.c-orange .ct{color:var(--orange);} .callout.c-cyan .ct{color:var(--cyan);}
  .callout.c-green .ct{color:var(--green);}

  .split{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .sub{background:rgba(0,0,0,0.22);border:1px solid var(--border);border-radius:5px;padding:9px;margin-top:8px;}
  .sub .sl{font-family:'JetBrains Mono',monospace;font-size:7.5px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-muted);margin-bottom:6px;}
  .sep{border-top:1px solid var(--border);margin:6px 0 5px;}

  .notes{margin-top:30px;display:grid;grid-template-columns:1fr 1fr;gap:11px;}
  .nc{background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:13px 15px;}
  .nc h3{font-family:'JetBrains Mono',monospace;font-size:9.5px;font-weight:600;margin-bottom:5px;display:flex;align-items:center;gap:5px;}
  .nc h3 .ni{width:16px;height:16px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:8.5px;}
  .nc p,.nc ul{font-size:9.5px;color:var(--text-dim);line-height:1.6;}
  .nc ul{list-style:none;padding:0;}
  .nc ul li{padding:2px 0 2px 11px;position:relative;}
  .nc ul li::before{content:'>';position:absolute;left:0;color:var(--text-muted);font-weight:600;}
  .nc.full{grid-column:1/-1;}
  .nc.n-gold h3{color:var(--gold);} .nc.n-gold .ni{background:rgba(232,185,49,0.1);color:var(--gold);}
  .nc.n-emerald h3{color:var(--emerald);} .nc.n-emerald .ni{background:rgba(16,185,129,0.1);color:var(--emerald);}
  .nc.n-orange h3{color:var(--orange);} .nc.n-orange .ni{background:rgba(251,146,60,0.12);color:var(--orange);}
  .nc.n-blue h3{color:var(--blue);} .nc.n-blue .ni{background:rgba(77,139,255,0.12);color:var(--blue);}
  .nc.n-cyan h3{color:var(--cyan);} .nc.n-cyan .ni{background:rgba(34,211,238,0.12);color:var(--cyan);}
  .nc.n-red h3{color:var(--red);} .nc.n-red .ni{background:rgba(248,113,113,0.12);color:var(--red);}
  .nc.n-purple h3{color:var(--purple);} .nc.n-purple .ni{background:rgba(167,139,250,0.12);color:var(--purple);}
  .nc.n-lime h3{color:var(--lime);} .nc.n-lime .ni{background:rgba(163,230,53,0.1);color:var(--lime);}
  .nc.n-teal h3{color:var(--teal);} .nc.n-teal .ni{background:rgba(45,212,191,0.1);color:var(--teal);}
  .nc.n-sky h3{color:var(--sky);} .nc.n-sky .ni{background:rgba(56,189,248,0.1);color:var(--sky);}

  .dual-panel{display:grid;grid-template-columns:1fr 1fr;gap:0;margin-bottom:12px;}
  .dual-panel .panel{border:1px solid var(--border);border-radius:0;padding:16px 14px 12px;position:relative;background:var(--surface);}
  .dual-panel .panel:first-child{border-radius:7px 0 0 7px;border-right:none;}
  .dual-panel .panel:last-child{border-radius:0 7px 7px 0;}
  .dual-panel .panel::before{content:attr(data-label);position:absolute;top:-9px;left:12px;font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;padding:2px 8px;border-radius:3px;background:var(--bg);z-index:2;}
  .panel.p-orange{border-color:rgba(251,146,60,0.35);} .panel.p-orange::before{color:var(--orange);border:1px solid rgba(251,146,60,0.35);}
  .panel.p-cyan{border-color:rgba(34,211,238,0.3);} .panel.p-cyan::before{color:var(--cyan);border:1px solid rgba(34,211,238,0.3);}

  .tag.teal{background:rgba(45,212,191,0.08);color:var(--teal);} .tag.pink{background:rgba(244,114,182,0.1);color:var(--pink);}
  .new-badge{font-family:'JetBrains Mono',monospace;font-size:7.5px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--lime);background:rgba(163,230,53,0.1);border:1px solid rgba(163,230,53,0.2);padding:1px 5px;border-radius:2px;margin-left:6px;}

  .nb{font-family:'JetBrains Mono',monospace;font-size:7px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--gold);background:rgba(232,185,49,0.1);border:1px solid rgba(232,185,49,0.2);padding:1px 4px;border-radius:2px;margin-left:3px;}

  .graph-viz{position:relative;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.06);border-radius:5px;padding:16px 14px 12px;margin-top:8px;overflow:hidden;}
  .graph-viz::before{content:attr(data-title);position:absolute;top:5px;left:10px;font-family:'JetBrains Mono',monospace;font-size:7px;text-transform:uppercase;letter-spacing:1.5px;opacity:0.35;}
  .graph-nodes{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;justify-content:center;align-items:center;}
  .gn{font-family:'JetBrains Mono',monospace;font-size:8.5px;padding:4px 8px;border-radius:3px;border:1px solid;white-space:nowrap;}
  .gn.gold{background:rgba(232,185,49,0.06);border-color:rgba(232,185,49,0.25);color:var(--gold);}
  .gn.emerald{background:rgba(16,185,129,0.06);border-color:rgba(16,185,129,0.25);color:var(--emerald);}
  .gn.dim{background:rgba(255,255,255,0.02);border-color:rgba(255,255,255,0.08);color:var(--text-muted);font-size:7.5px;padding:3px 6px;}
  .ge{color:var(--text-muted);font-family:'JetBrains Mono',monospace;font-size:9px;}

  /* View toggle */
  .view-toggle{display:flex;justify-content:center;gap:0;margin:18px auto 28px;width:fit-content;border-radius:5px;overflow:hidden;border:1px solid var(--border-accent);}
  .view-btn{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;padding:7px 20px;background:var(--surface);color:var(--text-muted);border:none;cursor:pointer;transition:all 0.15s ease;}
  .view-btn:hover{color:var(--text-dim);background:var(--surface-2);}
  .view-btn.active{background:var(--cyan);color:var(--bg);cursor:default;}
  .view-btn:first-child{border-right:1px solid var(--border-accent);}
  .view-overview{display:block;}
  .view-detail{display:none;}
  body.show-detail .view-overview{display:none;}
  body.show-detail .view-detail{display:block;}

  /* Overview-specific styles */
  .ov-stack{display:flex;flex-direction:column;gap:0;max-width:900px;margin:0 auto;}
  .ov-layer{position:relative;border:1px solid var(--border);border-radius:0;padding:14px 18px;background:var(--surface);display:flex;align-items:center;gap:14px;}
  .ov-layer:first-child{border-radius:7px 7px 0 0;}
  .ov-layer:last-child{border-radius:0 0 7px 7px;}
  .ov-layer+.ov-layer{border-top:none;}
  .ov-icon{width:32px;height:32px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
  .ov-body{flex:1;min-width:0;}
  .ov-name{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;margin-bottom:2px;}
  .ov-desc{font-size:10px;color:var(--text-dim);line-height:1.5;}
  .ov-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;}
  .ov-arrow{display:flex;align-items:center;justify-content:center;height:18px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);max-width:900px;margin:0 auto;}
  .ov-split{display:grid;grid-template-columns:1fr 1fr;gap:0;max-width:900px;margin:0 auto;}
  .ov-split .ov-layer{border-radius:0;}
  .ov-split .ov-layer:first-child{border-right:none;border-radius:0;}
  .ov-split .ov-layer:last-child{border-radius:0;}
  .ov-pipeline{display:flex;flex-wrap:wrap;align-items:center;gap:3px;margin-top:6px;}
  .ov-phase{font-family:'JetBrains Mono',monospace;font-size:7.5px;font-weight:600;padding:2px 6px;border-radius:3px;border:1px solid;}
  .ov-section{max-width:900px;margin:0 auto;}
  .ov-section-label{font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin:20px 0 8px;padding-left:2px;}

  @media(max-width:900px){.row,.split,.notes,.dual-panel,.graph-nodes{display:flex;flex-direction:column;} .nc.full{grid-column:1;} .canvas{padding:18px 12px 60px;} .dual-panel .panel{border-radius:7px!important;border:1px solid var(--border)!important;margin-bottom:10px;} .ov-split{grid-template-columns:1fr;} .ov-split .ov-layer{border-right:1px solid var(--border)!important;border-top:none;}}
</style>
</head>
<body>
<div class="canvas">

  <div class="header">
    <div class="badge">Architecture v3.2</div>
    <h1>Open <span class="hl">Autonomous Runtime</span></h1>
    <p>An agentic operating system that <strong style="color:var(--cyan)">magnifies human agency</strong>. You set the goals â€” the runtime plans, executes, reviews, and improves its own stack to deliver them. It <strong style="color:var(--emerald)">self-evolves</strong> by discovering tools, mutating its own config, and learning your preferences over time. It stays <strong style="color:var(--red)">secure</strong> through process isolation, a 3-stage sanitiser, and write fences that keep humans in the loop on dangerous ops. And it produces <strong style="color:var(--gold)">quality code</strong> by enforcing a strict BDD/TDD pipeline with architecture and security reviews built into every cycle. Not a copilot. A runtime.</p>
    <div class="changes">
      <span class="ch new">self-evolving</span>
      <span class="ch new">bdd/tdd pipeline</span>
      <span class="ch new">standards enforcement</span>
      <span class="ch kept">secure by design</span>
      <span class="ch kept">human guardrails</span>
      <span class="ch kept">dual agents</span>
      <span class="ch kept">domain memory</span>
      <span class="ch kept">code graph</span>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• VIEW TOGGLE â•â•â•â•â•â•â•â•â•â• -->
  <div class="view-toggle">
    <button class="view-btn active" onclick="toggleView('overview')">Overview</button>
    <button class="view-btn" onclick="toggleView('detail')">Detailed View</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• OVERVIEW VIEW â•â•â•â•â•â•â•â•â•â• -->
  <div class="view-overview">

    <div class="ov-section-label">Runtime Stack (top â†’ bottom)</div>
    <div class="ov-stack">
      <div class="ov-layer" style="border-color:rgba(56,189,248,0.3);">
        <div class="ov-icon" style="background:rgba(56,189,248,0.1);color:var(--sky);">ğŸ“Š</div>
        <div class="ov-body">
          <div class="ov-name" style="color:var(--sky);">Observability Dashboard</div>
          <div class="ov-desc">Read-only web UI. Process view, goal feed, tool timeline, security events, graph explorers.</div>
        </div>
      </div>
      <div class="ov-layer" style="border-color:rgba(167,139,250,0.3);">
        <div class="ov-icon" style="background:rgba(167,139,250,0.1);color:var(--purple);">ğŸ‘</div>
        <div class="ov-body">
          <div class="ov-name" style="color:var(--purple);">Supervisor <span style="font-size:8px;font-weight:400;color:var(--text-muted);">â€” the only immortal process</span></div>
          <div class="ov-desc">No LLM. Process manager + crash recovery + heartbeat. Exposes health API. Kill switch. If it dies, systemd restarts it.</div>
          <div class="ov-tags">
            <span class="tag purple">human gate</span>
            <span class="tag lime">fast-path router</span>
            <span class="tag purple">recovery state machine</span>
          </div>
        </div>
      </div>
    </div>

    <div class="ov-arrow">â–¼ spawns + manages</div>

    <div class="ov-split">
      <div class="ov-layer" style="border-color:rgba(251,146,60,0.35);">
        <div class="ov-icon" style="background:rgba(251,146,60,0.1);color:var(--orange);">ğŸ§ </div>
        <div class="ov-body">
          <div class="ov-name" style="color:var(--orange);">Meta-Agent <span style="font-size:8px;font-weight:400;color:var(--text-muted);">â€” Planner</span></div>
          <div class="ov-desc">Stock OpenCode, cheap model. Plans, decomposes, dispatches. Never touches code or external APIs directly.</div>
          <div class="ov-tags">
            <span class="tag orange">tier-0</span>
            <span class="tag orange">10 internal tools</span>
            <span class="tag gold">reads/writes user KG</span>
            <span class="tag emerald">reads code graph</span>
          </div>
        </div>
      </div>
      <div class="ov-layer" style="border-color:rgba(34,211,238,0.3);border-left:1px solid rgba(34,211,238,0.3);">
        <div class="ov-icon" style="background:rgba(34,211,238,0.1);color:var(--cyan);">âš¡</div>
        <div class="ov-body">
          <div class="ov-name" style="color:var(--cyan);">Worker <span style="font-size:8px;font-weight:400;color:var(--text-muted);">â€” Executor</span></div>
          <div class="ov-desc">Stock OpenCode, strong model. Executes one phase at a time. Ephemeral and replaceable. Can escalate to planner.</div>
          <div class="ov-tags">
            <span class="tag cyan">tier-1</span>
            <span class="tag cyan">dynamic tools</span>
            <span class="tag gold">reads user KG</span>
            <span class="tag emerald">reads code graph</span>
            <span class="tag red">sanitiser required</span>
          </div>
        </div>
      </div>
    </div>

    <div class="ov-arrow">â–¼ communicate via shared state (not direct connection)</div>

    <div class="ov-stack">
      <div class="ov-layer" style="border-color:rgba(77,139,255,0.3);">
        <div class="ov-icon" style="background:rgba(77,139,255,0.1);color:var(--blue);">ğŸ’¾</div>
        <div class="ov-body">
          <div class="ov-name" style="color:var(--blue);">Shared State Store</div>
          <div class="ov-desc">SQLite WAL / Postgres. Goals, tasks, tool logs, checkpoints, escalations. The bridge between both instances.</div>
          <div class="ov-tags">
            <span class="tag blue">checkpointer</span>
            <span class="tag blue">context rebuilder</span>
            <span class="tag blue">crash recovery</span>
          </div>
        </div>
      </div>
    </div>

    <div class="ov-arrow">â–¼ graph stores</div>

    <div class="ov-split">
      <div class="ov-layer" style="border-color:rgba(232,185,49,0.35);">
        <div class="ov-icon" style="background:rgba(232,185,49,0.1);color:var(--gold);">ğŸ‘¤</div>
        <div class="ov-body">
          <div class="ov-name" style="color:var(--gold);">User Knowledge Graph</div>
          <div class="ov-desc">Domain context: people, projects, preferences, deadlines, conventions. Long-lived. Grows over time.</div>
        </div>
      </div>
      <div class="ov-layer" style="border-color:rgba(16,185,129,0.35);border-left:1px solid rgba(16,185,129,0.35);">
        <div class="ov-icon" style="background:rgba(16,185,129,0.1);color:var(--emerald);">ğŸ—º</div>
        <div class="ov-body">
          <div class="ov-name" style="color:var(--emerald);">RPG Code Graph</div>
          <div class="ov-desc">Repo structure: files, modules, deps, data flows. Built via AST parsing. Disposable â€” re-derivable from code.</div>
        </div>
      </div>
    </div>

    <div class="ov-arrow">â–¼ proxied tool access</div>

    <div class="ov-split">
      <div class="ov-layer" style="border-color:rgba(251,146,60,0.25);">
        <div class="ov-icon" style="background:rgba(251,146,60,0.08);color:var(--orange);">â‡„</div>
        <div class="ov-body">
          <div class="ov-name" style="color:var(--orange);">MCP Proxy â€” Meta-Agent</div>
          <div class="ov-desc">Static manifest. 10 internal tools. No sanitiser needed.</div>
        </div>
      </div>
      <div class="ov-layer" style="border-color:rgba(34,211,238,0.25);border-left:1px solid rgba(34,211,238,0.25);">
        <div class="ov-icon" style="background:rgba(34,211,238,0.08);color:var(--cyan);">â‡„</div>
        <div class="ov-body">
          <div class="ov-name" style="color:var(--cyan);">MCP Proxy â€” Worker</div>
          <div class="ov-desc">Dynamic manifest. Hot-swappable. All traffic passes through 3-stage sanitiser. Circuit breaker.</div>
        </div>
      </div>
    </div>

    <div class="ov-arrow">â–¼ sanitised access to external tools</div>

    <div class="ov-stack">
      <div class="ov-layer" style="border-color:rgba(248,113,113,0.3);">
        <div class="ov-icon" style="background:rgba(248,113,113,0.1);color:var(--red);">ğŸ›¡</div>
        <div class="ov-body">
          <div class="ov-name" style="color:var(--red);">Security Sandbox <span style="font-size:8px;font-weight:400;color:var(--text-muted);">â€” Worker proxy only</span></div>
          <div class="ov-desc">3-stage sanitiser: regex heuristics â†’ structural strip â†’ optional LLM classifier. Fail-closed. Scans inbound + outbound.</div>
        </div>
      </div>
      <div class="ov-layer" style="border-color:rgba(251,191,36,0.25);">
        <div class="ov-icon" style="background:rgba(251,191,36,0.08);color:var(--amber);">ğŸ”§</div>
        <div class="ov-body">
          <div class="ov-name" style="color:var(--amber);">Downstream MCP Tool Servers</div>
          <div class="ov-desc">Search, email, database, filesystem, code execution, custom servers. External, hot-swappable.</div>
        </div>
      </div>
    </div>

    <!-- BDD/TDD Pipeline overview -->
    <div class="ov-section-label">Development Pipeline (per coding task)</div>
    <div class="ov-section">
      <div class="ov-layer" style="border-color:rgba(45,212,191,0.3);border-radius:7px;">
        <div class="ov-icon" style="background:rgba(45,212,191,0.1);color:var(--teal);">ğŸ”„</div>
        <div class="ov-body">
          <div class="ov-name" style="color:var(--teal);">BDD/TDD Phase Pipeline <span style="font-size:8px;font-weight:400;color:var(--text-muted);">â€” enforced by Meta-Agent, executed by Worker</span></div>
          <div class="ov-desc">Each phase is a separate dispatch. Worker sees only the current phase. Git commit after every phase. Meta-Agent verifies gate before advancing.</div>
          <div class="ov-pipeline">
            <span class="ov-phase" style="color:var(--gold);border-color:rgba(232,185,49,0.3);background:rgba(232,185,49,0.06);">â‘  Feature</span>
            <span style="color:var(--text-muted);font-size:8px;">â†’</span>
            <span class="ov-phase" style="color:var(--cyan);border-color:rgba(34,211,238,0.3);background:rgba(34,211,238,0.06);">â‘¡ Steps</span>
            <span style="color:var(--text-muted);font-size:8px;">â†’</span>
            <span class="ov-phase" style="color:var(--purple);border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.06);">â‘¢ Units</span>
            <span style="color:var(--text-muted);font-size:8px;">â†’</span>
            <span class="ov-phase" style="color:var(--red);border-color:rgba(248,113,113,0.3);background:rgba(248,113,113,0.06);">â‘£ Red</span>
            <span style="color:var(--text-muted);font-size:8px;">â†’</span>
            <span class="ov-phase" style="color:var(--green);border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.06);">â‘¤ Green</span>
            <span style="color:var(--text-muted);font-size:8px;">â†’</span>
            <span class="ov-phase" style="color:var(--sky);border-color:rgba(56,189,248,0.3);background:rgba(56,189,248,0.06);">â‘¥ Refactor</span>
            <span style="color:var(--text-muted);font-size:8px;">â†’</span>
            <span class="ov-phase" style="color:var(--orange);border-color:rgba(251,146,60,0.3);background:rgba(251,146,60,0.06);">â‘¦ Arch</span>
            <span style="color:var(--text-muted);font-size:8px;">â†’</span>
            <span class="ov-phase" style="color:var(--rose);border-color:rgba(251,113,133,0.3);background:rgba(251,113,133,0.06);">â‘§ Sec</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Key Principles overview -->
    <div class="ov-section-label">Key Principles</div>
    <div class="ov-section" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:10px 12px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;color:var(--purple);margin-bottom:4px;">Stability Hierarchy</div>
        <div style="font-size:9px;color:var(--text-dim);line-height:1.5;">
          <span class="tag purple">Supervisor</span> immortal â†’
          <span class="tag orange">Meta-Agent</span> tier-0 â†’
          <span class="tag cyan">Worker</span> tier-1 expendable
        </div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:10px 12px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;color:var(--red);margin-bottom:4px;">Security Isolation</div>
        <div style="font-size:9px;color:var(--text-dim);line-height:1.5;">
          Two instances share <strong>no tools</strong>. Worker compromised? Can't reach Planner. Can't write to graphs. Sanitiser on all external I/O.
        </div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:10px 12px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;color:var(--lime);margin-bottom:4px;">Dogfooding</div>
        <div style="font-size:9px;color:var(--text-dim);line-height:1.5;">
          Both agents are stock OpenCode. You build small MCP tool servers + a supervisor. The orchestration <em>emerges</em> from prompt + tools.
        </div>
      </div>
    </div>

    <div style="text-align:center;margin-top:24px;">
      <button class="view-btn" onclick="toggleView('detail')" style="border-radius:5px;border:1px solid rgba(34,211,238,0.3);color:var(--cyan);">View Full Detailed Architecture â†’</button>
    </div>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• DETAILED VIEW (existing content) â•â•â•â•â•â•â•â•â•â• -->
  <div class="view-detail">

  <!-- â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â• -->
  <div class="layer l-sky" data-label="Observability Dashboard Â· Runtime Visibility">
    <div class="row">
      <div class="box b-sky" style="flex:2;">
        <div class="t"><span class="ic">ğŸ“Š</span> Live Dashboard (Web UI)</div>
        <div class="d">
          Real-time view of the entire runtime. Read-only â€” it observes but never mutates. Built as a simple web app
          that polls the State Store + Supervisor health API. Runs as a separate process managed by the Supervisor.
          Think: the runtime equivalent of the process tree diagram, but live.
        </div>
      </div>
      <div class="box b-sky">
        <div class="t"><span class="ic">ğŸ”´</span> Live Process View</div>
        <div class="d">
          Process tree with real-time status: <span class="tag green">running</span> <span class="tag amber">recovering</span>
          <span class="tag red">crashed</span> <span class="tag purple">paused</span> for every child.
          Uptime, restart count, current model, memory usage per instance.
        </div>
      </div>
    </div>
    <div class="row">
      <div class="box b-sky">
        <div class="t"><span class="ic">ğŸ“‹</span> Goal & Task Feed</div>
        <div class="d">
          Live stream of the Goal Queue. Current goal, decomposed sub-tasks, completion status. See what the
          Meta-Agent is planning and what the Worker is executing. Clickable to inspect full task payloads.
        </div>
      </div>
      <div class="box b-sky">
        <div class="t"><span class="ic">ğŸ”§</span> Tool Call Timeline</div>
        <div class="d">
          Chronological feed of every tool call (both instances). Shows: tool name, args (truncated), response status,
          latency, sanitiser verdict (pass/block). Filterable by instance, tool, and status. This is your debugging lifeline.
        </div>
      </div>
      <div class="box b-sky">
        <div class="t"><span class="ic">ğŸ›¡</span> Security Events</div>
        <div class="d">
          Sanitiser verdicts, blocked injections with raw payload preview, injection frequency per tool,
          auto-disable events. Links to full audit log entries. Alerts when injection rate exceeds threshold.
        </div>
      </div>
    </div>
    <div class="row">
      <div class="box b-sky">
        <div class="t"><span class="ic">â¸</span> Escalation Queue</div>
        <div class="d">
          Worker escalation requests waiting for Meta-Agent or human review.
          Shows the Worker's question, context snapshot, and available actions:
          respond, override, or abort task.
        </div>
      </div>
      <div class="box b-sky"><div class="t"><span class="ic">ğŸ‘¤</span> Entity Explorer <span class="nb">new</span></div><div class="d">Browse the User Knowledge Graph. See people, projects, preferences, and their relationships. Understand what the agents "know about you".</div></div>
      <div class="box b-sky"><div class="t"><span class="ic">ğŸ—º</span> Repo Map <span class="nb">new</span></div><div class="d">Visualise the Code Graph. Module hierarchy, file deps, data flows. See the agent's structural understanding of your codebase.</div></div>
      <div class="box b-sky"><div class="t"><span class="ic">â›³</span> Human Gate</div><div class="d">Approval queue + escalation responses. Gate actions embeddable in dashboard UI.</div></div>
    </div>
    <div class="callout c-sky" style="margin-top:8px;">
      <div class="ct">âœ¦ Implementation Note</div>
      <div class="cb">
        The dashboard is a thin web UI (React / plain HTML) that reads from two sources: the <strong>State Store</strong>
        (goals, tasks, tool logs, escalations, checkpoints) and the <strong>Supervisor's health API</strong> (process status,
        heartbeat data, resource usage). It writes nothing â€” pure read-only observer. Optional: SSE/WebSocket push
        from State Store for live updates without polling. The Human Gate approval actions can be embedded here too,
        making it the single pane of glass for both observation and control.
      </div>
    </div>
  </div>

  <div class="arrow"><span class="dir">â–¼</span> reads from all stores + supervisor api</div>

  <!-- â•â•â•â•â•â•â•â•â•â• SUPERVISOR â•â•â•â•â•â•â•â•â•â• -->
  <div class="layer l-purple" data-label="Supervisor Â· The Only Immortal Process">
    <div class="row">
      <div class="box b-purple" style="flex:2;">
        <div class="t"><span class="ic">ğŸ‘</span> Supervisor</div>
        <div class="d">
          Manages all child processes. Heartbeat + crash recovery with tiered priority.
          No LLM, no planning â€” just process management, signal handling, and the recovery state machine.
          This is what makes it stable: it has almost no reasons to crash. If it does, systemd/Docker restarts it.
          Exposes a <strong>health API</strong> (HTTP) for the dashboard.
        </div>
      </div>
      <div class="box b-purple">
        <div class="t"><span class="ic">ğŸ’“</span> Dual Heartbeat</div>
        <div class="d">
          Monitors both OpenCode instances independently via <code>waitpid()</code> + liveness probes.
          <strong>Instant crash detection</strong> (zero latency) â€” <code>waitpid()</code> returns the moment a child exits.
          Periodic liveness probe for hang detection â€” if no output for <code>timeout_ms</code>, treat as hung.
          <span class="tag red">Detects: exit</span> <span class="tag red">hang</span> <span class="tag red">OOM</span>
          <div class="sep"></div>
          If the <strong>Worker</strong> crashes â†’ recover using Meta-Agent's last plan.
          If the <strong>Meta-Agent</strong> crashes â†’ recover it first (higher priority), then it re-dispatches the Worker.
          <div class="sep"></div>
          <span class="tag purple">meta first</span> <span class="tag cyan">worker second</span>
          Exponential backoff, max 5 retries â†’ alert Human Gate.
        </div>
      </div>
      <div class="box b-pink">
        <div class="t"><span class="ic">â›³</span> Human Gate</div>
        <div class="d">
          <span class="tag orange">full-auto</span> <span class="tag purple">approve-goals</span> <span class="tag red">approve-all</span>
          <div class="sep"></div>
          Plus <strong>write fence</strong>: dangerous ops require approval even in full-auto.
          Also surfaces <strong>escalation requests</strong> from the Worker. Gate actions embeddable in dashboard UI.
          Write fence per-instance: Meta-Agent config mutations and Worker destructive ops can have independent gate policies.
          <strong>Gate mode is a runtime flag</strong> â€” switch between modes without restarting any process.
        </div>
      </div>
      <div class="box b-lime">
        <div class="t"><span class="ic">âš¡</span> Fast Path Router</div>
        <div class="d">Rule engine (no LLM). <span class="tag lime">fast</span> <span class="tag orange">full</span> <span class="tag purple">gated</span>
          <span class="tag gold">new</span> Can query User KG for context ("does user prefer X for this type of task?")
        </div>
      </div>
    </div>
    <div class="callout c-lime" style="margin-top:8px;">
      <div class="ct">âœ¦ Fast Path â€” Trivial Task Bypass</div>
      <div class="cb">
        Not every task needs decomposition. The Supervisor includes a <strong>fast-path classifier</strong>
        â€” a lightweight rule engine (no LLM) that scores incoming tasks by complexity signals:
        <strong>single-step?</strong> (e.g. "format this file"), <strong>no ambiguity?</strong> (clear input/output),
        <strong>no tool mutation needed?</strong> (current tools suffice). If all signals pass, the task goes directly
        to the Worker, skipping the Meta-Agent entirely. The Meta-Agent is notified after completion
        (via State Store) so it stays aware of system state. This cuts latency and cost for simple tasks by ~50%
        (no planner LLM call). The classifier is configurable â€” you can set the threshold or disable fast-path entirely.
      </div>
    </div>
    <div class="callout c-purple" style="margin-top:8px;">
      <div class="ct">âœ¦ Recovery Sequence (on crash detection)</div>
      <div class="cb">
        <strong>â‘ </strong> Kill hung process (if still alive â€” e.g. OOM but not yet reaped).
        <strong>â‘¡</strong> Read last checkpoint from State Store (task ID, tool log, plan state).
        <strong>â‘¢</strong> Rebuild config via DSL (same config-as-code the instance was spawned with).
        <strong>â‘£</strong> Inject resume context via Context Rebuilder (compressed checkpoint â†’ system prompt).
        <strong>â‘¤</strong> Respawn fresh OpenCode process (new PID, clean slate, resume prompt).
        <strong>â‘¥</strong> Exponential backoff if repeated failures. Max 5 retries â†’ alert Human Gate.
        <div class="sep"></div>
        Also exposes a <strong>kill switch</strong>: <code>/stop</code> HTTP endpoint + <code>SIGTERM</code> handler â†’ instant halt of all children. Emergency brake for runaway agents.
      </div>
    </div>
  </div>

  <div class="arrow"><span class="dir">â–¼</span> spawns and manages both instances</div>

  <!-- â•â•â•â•â•â•â•â•â•â• FAST PATH ROUTING â•â•â•â•â•â•â•â•â•â• -->
  <div class="layer l-lime" data-label="Task Router Â· Fast Path Decision Point" style="padding:16px 16px 14px;">
    <div class="row">
      <div class="box b-lime" style="flex:1;">
        <div class="t"><span class="ic">âš¡</span> Fast Path (trivial)</div>
        <div class="d">
          Rule engine says: single-step, unambiguous, existing tools suffice.
          Task goes <strong>directly to Worker</strong>. Meta-Agent notified post-completion via State Store.
          <div class="sep"></div>
          <span style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--lime);">
            task â†’ classifier â†’ FAST â†’ Worker â†’ done â†’ State Store â†’ Meta-Agent reads
          </span>
        </div>
      </div>
      <div class="box b-orange" style="flex:1;">
        <div class="t"><span class="ic">ğŸ§ </span> Full Path (complex)</div>
        <div class="d">
          Classifier says: multi-step, ambiguous, or needs tool changes.
          Task goes to <strong>Meta-Agent for decomposition</strong>. Normal planning loop.
          <div class="sep"></div>
          <span style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--orange);">
            task â†’ classifier â†’ FULL â†’ Meta-Agent â†’ plan â†’ dispatch â†’ Worker â†’ State Store
          </span>
        </div>
      </div>
      <div class="box b-purple" style="flex:1;">
        <div class="t"><span class="ic">â›³</span> Gated Path (dangerous)</div>
        <div class="d">
          Classifier or Human Gate flags: destructive, high-cost, or security-sensitive.
          Task <strong>pauses for human approval</strong> before any routing.
          <div class="sep"></div>
          <span style="font-family:'JetBrains Mono',monospace;font-size:8.5px;color:var(--purple);">
            task â†’ classifier â†’ GATE â†’ Human Gate â†’ approve â†’ (fast or full path)
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="arrow"><span class="dir">â–¼</span> routes to appropriate instance</div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- â•â•â•â•â•â•â•â•â•â• DUAL GRAPH LAYER â€” THE NEW THING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="split" style="margin-bottom:12px;">

    <!-- LEFT: USER KNOWLEDGE GRAPH -->
    <div class="layer l-gold" data-label="User Knowledge Graph Â· Domain Context  â€” NEW" style="margin-bottom:0;">
      <div class="row">
        <div class="box b-gold" style="min-width:100%;">
          <div class="t"><span class="ic">ğŸ‘¤</span> Entity-Relationship Store</div>
          <div class="d">
            A persistent graph of the <strong>user's world</strong>. Nodes are domain entities â€” people, projects, clients, teams, products,
            preferences, business rules, conventions, deadlines. Edges are typed relationships with metadata.
            This is <em>not</em> about code â€” it's about understanding <strong>who you are and what you care about</strong>
            so agents make contextually appropriate decisions.
          </div>
        </div>
      </div>

      <div class="graph-viz" data-title="USER KNOWLEDGE GRAPH Â· EXAMPLE" style="border-color:rgba(232,185,49,0.15);">
        <div class="graph-nodes">
          <span class="gn gold">ğŸ‘¤ user:alice</span>
          <span class="ge">â€”OWNSâ†’</span>
          <span class="gn gold">ğŸ“‚ project:acme-saas</span>
          <span class="ge">â€”HAS_CLIENTâ†’</span>
          <span class="gn gold">ğŸ¢ org:megacorp</span>
        </div>
        <div class="graph-nodes" style="margin-top:5px;">
          <span class="gn gold">ğŸ‘¤ user:alice</span>
          <span class="ge">â€”PREFERSâ†’</span>
          <span class="gn gold">ğŸ“ style:minimal-comments</span>
          <span class="ge">&nbsp;</span>
          <span class="gn gold">ğŸ“‚ project:acme-saas</span>
          <span class="ge">â€”USES_STACKâ†’</span>
          <span class="gn gold">ğŸ›  stack:next+postgres</span>
        </div>
        <div class="graph-nodes" style="margin-top:5px;">
          <span class="gn gold">ğŸ“‚ project:acme-saas</span>
          <span class="ge">â€”HAS_DEADLINEâ†’</span>
          <span class="gn gold">ğŸ“… date:2026-03-01</span>
          <span class="ge">&nbsp;</span>
          <span class="gn gold">ğŸ¢ org:megacorp</span>
          <span class="ge">â€”REQUIRESâ†’</span>
          <span class="gn gold">ğŸ“‹ compliance:SOC2</span>
        </div>
        <div class="graph-nodes" style="margin-top:5px;">
          <span class="gn gold">ğŸ‘¤ user:alice</span>
          <span class="ge">â€”WORKS_WITHâ†’</span>
          <span class="gn gold">ğŸ‘¤ person:bob</span>
          <span class="ge">â€”ROLEâ†’</span>
          <span class="gn gold">ğŸ¯ role:backend-lead</span>
          <span class="ge">&nbsp;</span>
          <span class="gn gold">ğŸ“‚ project:acme-saas</span>
          <span class="ge">â€”CONVENTIONâ†’</span>
          <span class="gn gold">ğŸ“ rule:no-orms</span>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="box b-gold">
          <div class="t"><span class="ic">ğŸ“</span> Entity Types</div>
          <div class="d">
            <span class="tag gold">person</span> <span class="tag gold">project</span> <span class="tag gold">org</span>
            <span class="tag gold">team</span> <span class="tag gold">preference</span> <span class="tag gold">convention</span>
            <span class="tag gold">deadline</span> <span class="tag gold">stack</span> <span class="tag gold">compliance</span>
            <span class="tag gold">product</span> <span class="tag gold">domain-concept</span> <span class="tag gold">decision</span>
          </div>
        </div>
        <div class="box b-gold">
          <div class="t"><span class="ic">â†”</span> Relationship Types</div>
          <div class="d">
            <span class="tag gold">OWNS</span> <span class="tag gold">PREFERS</span> <span class="tag gold">WORKS_WITH</span>
            <span class="tag gold">HAS_CLIENT</span> <span class="tag gold">USES_STACK</span> <span class="tag gold">REQUIRES</span>
            <span class="tag gold">CONVENTION</span> <span class="tag gold">HAS_DEADLINE</span> <span class="tag gold">DECIDED</span>
            <span class="tag gold">DISLIKES</span>
          </div>
        </div>
      </div>
      <div class="callout c-gold" style="margin-top:8px;">
        <div class="ct">âœ¦ Populated By</div>
        <div class="cb">
          <strong>â‘  User directly</strong> â€” onboarding flow or dashboard edits ("I prefer typed SQL over ORMs", "client needs SOC2").
          <strong>â‘¡ Meta-Agent</strong> â€” infers entities from conversations and task patterns over time ("user always chooses Tailwind").
          <strong>â‘¢ Never by Worker</strong> â€” same injection-safety principle. Worker reads, never writes.
        </div>
      </div>
    </div>

    <!-- RIGHT: RPG CODE GRAPH -->
    <div class="layer l-emerald" data-label="RPG Code Graph Â· Repo Structure  â€” NEW" style="margin-bottom:0;">
      <div class="row">
        <div class="box b-emerald" style="min-width:100%;">
          <div class="t"><span class="ic">ğŸ—º</span> Repository Planning Graph</div>
          <div class="d">
            An RPG-style structural graph of the <strong>current codebase</strong>. Encodes file hierarchy, module boundaries,
            inter-module data flows, function signatures, class inheritance, and import dependencies.
            Inspired by <a href="https://arxiv.org/abs/2509.16198" style="color:var(--emerald);">Microsoft RPG/ZeroRepo</a>.
            This is a <strong>code quality feature</strong> â€” it helps the Worker write structurally coherent code
            by understanding what exists, what depends on what, and where new code should go.
          </div>
        </div>
      </div>

      <div class="graph-viz" data-title="RPG CODE GRAPH Â· EXAMPLE" style="border-color:rgba(16,185,129,0.15);">
        <div class="graph-nodes">
          <span class="gn emerald">ğŸ“¦ module:auth</span>
          <span class="ge">â€”CONTAINSâ†’</span>
          <span class="gn emerald">ğŸ“„ file:auth/handler.ts</span>
          <span class="ge">â€”EXPORTSâ†’</span>
          <span class="gn emerald">fn:verifyToken()</span>
        </div>
        <div class="graph-nodes" style="margin-top:5px;">
          <span class="gn emerald">ğŸ“„ file:api/routes.ts</span>
          <span class="ge">â€”IMPORTSâ†’</span>
          <span class="gn emerald">fn:verifyToken()</span>
          <span class="ge">&nbsp;</span>
          <span class="gn emerald">ğŸ“¦ module:api</span>
          <span class="ge">â€”DATA_FLOWâ†’</span>
          <span class="gn emerald">ğŸ“¦ module:auth</span>
        </div>
        <div class="graph-nodes" style="margin-top:5px;">
          <span class="gn emerald">ğŸ“„ file:auth/handler.ts</span>
          <span class="ge">â€”DEPENDS_ONâ†’</span>
          <span class="gn emerald">ğŸ“¦ pkg:jsonwebtoken</span>
          <span class="ge">&nbsp;</span>
          <span class="gn emerald">class:AuthService</span>
          <span class="ge">â€”EXTENDSâ†’</span>
          <span class="gn emerald">class:BaseService</span>
        </div>
        <div class="graph-nodes" style="margin-top:5px;">
          <span class="gn dim">traversal: Worker asks "where should I add rate limiting?"</span>
          <span class="ge">â†’</span>
          <span class="gn dim">walks: module:api â†’ DATA_FLOW â†’ modules â†’ CONTAINS â†’ files</span>
          <span class="ge">â†’</span>
          <span class="gn dim">finds: middleware layer, existing patterns, dep chain</span>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="box b-emerald">
          <div class="t"><span class="ic">ğŸ“</span> Node Types</div>
          <div class="d">
            <span class="tag emerald">module</span> <span class="tag emerald">file</span> <span class="tag emerald">function</span>
            <span class="tag emerald">class</span> <span class="tag emerald">interface</span> <span class="tag emerald">package</span>
            <span class="tag emerald">route</span> <span class="tag emerald">schema</span> <span class="tag emerald">test</span>
          </div>
        </div>
        <div class="box b-emerald">
          <div class="t"><span class="ic">â†”</span> Edge Types</div>
          <div class="d">
            <span class="tag emerald">CONTAINS</span> <span class="tag emerald">IMPORTS</span> <span class="tag emerald">EXPORTS</span>
            <span class="tag emerald">DATA_FLOW</span> <span class="tag emerald">EXTENDS</span> <span class="tag emerald">IMPLEMENTS</span>
            <span class="tag emerald">DEPENDS_ON</span> <span class="tag emerald">TESTS</span> <span class="tag emerald">CALLS</span>
          </div>
        </div>
      </div>
      <div class="callout c-emerald" style="margin-top:8px;">
        <div class="ct">âœ¦ Populated By</div>
        <div class="cb">
          <strong>â‘  Static analysis on init</strong> â€” AST parse on repo load. Builds initial graph from imports, exports, class hierarchy.
          <strong>â‘¡ Worker's Checkpointer</strong> â€” auto-updates after file edits (new files, changed imports, added functions).
          <strong>â‘¢ Meta-Agent</strong> â€” can annotate with higher-level module boundaries and data flow intentions.
          Lightweight â€” no LLM needed for extraction, just tree-sitter / AST parsing.
        </div>
      </div>
    </div>
  </div>

  <div class="arrow"><span class="dir">â–¼</span> both agents access graphs via mcp tools</div>

  <!-- â•â•â•â•â•â•â•â•â•â• DUAL OPENCODE INSTANCES â•â•â•â•â•â•â•â•â•â• -->
  <div class="dual-panel">
    <div class="panel p-orange" data-label="OpenCode â‘  Â· Meta-Agent (Planner)">
      <div class="box b-orange" style="min-width:100%;margin-bottom:7px;">
        <div class="t"><span class="ic">ğŸ§ </span> Planner Instance</div>
        <div class="d">
          Stock OpenCode, planning system prompt, cheap/fast model (Haiku/Sonnet).
          This instance never touches the codebase or external APIs directly. It only plans, evaluates, and dispatches.
          <span class="tag orange">tier-0</span> Recovered first. If this is down, the Worker has no direction. Only internal tools, no injection surface.
          <div class="sep"></div>
          <span class="tag gold">new</span> Traverses User KG to align plans with user preferences, deadlines, team context.
          <span class="tag emerald">new</span> Reads Code Graph to understand repo structure before decomposing coding tasks.
          Also handles <strong>escalation responses</strong>: reads Worker's
          <code>request_clarification</code> entries from State Store, reasons about them, and writes guidance
          back â€” which the Worker receives on its next checkpoint resume or via a <code>check_escalation_response</code> tool.
        </div>
      </div>
      <div class="sub">
        <div class="sl">Meta-Agent MCP Tools (10 â€” was 6, +4 graph Â· static manifest)</div>
        <div class="row">
          <div class="box b-orange" style="padding:6px 8px;">
            <div class="t" style="font-size:8.5px;">ğŸ“‹ goal_queue</div>
             <div class="d"><code>push</code> <code>pop</code> <code>peek</code> <code>reprioritise</code> â€” manages the persistent goal queue</div>
          </div>
          <div class="box b-orange" style="padding:6px 8px;">
            <div class="t" style="font-size:8.5px;">ğŸ“– state_reader</div>
             <div class="d"><code>get_checkpoint</code> <code>get_task_log</code> <code>get_escalations</code> â€” reads Worker's progress</div>
          </div>
          <div class="box b-orange" style="padding:6px 8px;">
            <div class="t" style="font-size:8.5px;">ğŸ”§ worker_control</div>
             <div class="d"><code>dispatch</code> <code>abort</code> <code>respond_escalation</code> â€” sends phase-locked work to Worker. Dispatch includes <code>phase</code>, <code>forbidden_actions</code>, <code>success_criteria</code></div>
          </div>
        </div>
        <div class="row">
          <div class="box b-orange" style="padding:6px 8px;">
            <div class="t" style="font-size:8.5px;">ğŸ“¡ proxy_admin</div>
             <div class="d"><code>register</code> <code>deregister</code> <code>list</code> â€” mutates Worker's tool manifest</div>
          </div>
          <div class="box b-orange" style="padding:6px 8px;">
            <div class="t" style="font-size:8.5px;">âš™ config_mutator</div>
             <div class="d"><code>update_prompt</code> <code>update_model</code> <code>update_agents</code> â€” evolves Worker's config via DSL</div>
          </div>
          <div class="box b-orange" style="padding:6px 8px;">
            <div class="t" style="font-size:8.5px;">ğŸ” tool_registry</div>
             <div class="d"><code>search</code> <code>inspect</code> <code>install</code> â€” discovers new MCP servers from catalogue</div>
          </div>
        </div>
        <div class="row">
          <div class="box b-gold" style="padding:6px 8px;"><div class="t" style="font-size:8.5px;">ğŸ‘¤ user_kg_read <span class="nb">new</span></div><div class="d"><code>query</code> <code>traverse</code> <code>search</code></div></div>
          <div class="box b-gold" style="padding:6px 8px;"><div class="t" style="font-size:8.5px;">âœ user_kg_write <span class="nb">new</span></div><div class="d"><code>add_entity</code> <code>add_edge</code> <code>annotate</code></div></div>
        </div>
        <div class="row">
          <div class="box b-emerald" style="padding:6px 8px;"><div class="t" style="font-size:8.5px;">ğŸ—º code_graph_read <span class="nb">new</span></div><div class="d"><code>expand</code> <code>path</code> <code>topo_order</code></div></div>
          <div class="box b-emerald" style="padding:6px 8px;"><div class="t" style="font-size:8.5px;">âœ code_graph_write <span class="nb">new</span></div><div class="d"><code>annotate_module</code> <code>set_data_flow</code></div></div>
        </div>
      </div>
      <div class="callout c-orange" style="margin-top:8px;">
        <div class="ct">âœ¦ The Loop (from the Meta-Agent's perspective)</div>
        <div class="cb">
          The Meta-Agent's system prompt says: "You are a task planner. Use your tools to: read the goal queue,
          check worker status, decompose goals into tasks, dispatch tasks, evaluate results, and generate follow-up
          goals. You may also evolve the worker's tools and config when needed."
          It's just an LLM with tools â€” the loop emerges from the prompt + tool availability.
          <div class="sep"></div>
          <strong>Phase-locked dispatch:</strong> For coding tasks, the Meta-Agent decomposes into a strict BDD/TDD pipeline.
          Each dispatch is a single, isolated phase. The Worker only sees the current phase â€” never what comes next.
          Every phase ends with a <strong>commit</strong> before the Meta-Agent advances.
          <div style="display:flex;flex-wrap:wrap;align-items:center;gap:4px;margin:7px 0 5px;">
            <span class="tag gold" style="font-size:8px;padding:2px 6px;">â‘  FEATURE</span>
            <span style="color:var(--text-muted);font-size:9px;">â†’ commit â†’</span>
            <span class="tag cyan" style="font-size:8px;padding:2px 6px;">â‘¡ STEP TESTS</span>
            <span style="color:var(--text-muted);font-size:9px;">â†’ commit â†’</span>
            <span class="tag purple" style="font-size:8px;padding:2px 6px;">â‘¢ UNIT TESTS</span>
            <span style="color:var(--text-muted);font-size:9px;">â†’ commit â†’</span>
            <span class="tag red" style="font-size:8px;padding:2px 6px;">â‘£ RED</span>
            <span style="color:var(--text-muted);font-size:9px;">â†’ commit â†’</span>
            <span class="tag green" style="font-size:8px;padding:2px 6px;">â‘¤ GREEN</span>
            <span style="color:var(--text-muted);font-size:9px;">â†’ commit â†’</span>
            <span class="tag sky" style="font-size:8px;padding:2px 6px;">â‘¥ REFACTOR</span>
            <span style="color:var(--text-muted);font-size:9px;">â†’ commit â†’</span>
            <span class="tag orange" style="font-size:8px;padding:2px 6px;">â‘¦ ARCH REVIEW</span>
            <span style="color:var(--text-muted);font-size:9px;">â†’ commit â†’</span>
            <span class="tag rose" style="font-size:8px;padding:2px 6px;">â‘§ SEC REVIEW</span>
            <span style="color:var(--text-muted);font-size:9px;">â†’ commit</span>
          </div>
          <span style="font-size:8.5px;color:var(--text-dim);">
            The Meta-Agent verifies the <strong>phase gate</strong> (e.g. "tests exist and fail?") before advancing.
            If the Worker strayed â†’ re-dispatch same phase. Phases
            <span class="tag orange" style="font-size:7.5px;">â‘¦</span> <span class="tag rose" style="font-size:7.5px;">â‘§</span>
            are <strong>audit-only</strong> â€” violations feed back as targeted fix dispatches, then re-audit.
          </span>
        </div>
      </div>
    </div>

    <div class="panel p-cyan" data-label="OpenCode â‘¡ Â· Worker (Executor)">
      <div class="box b-cyan" style="min-width:100%;margin-bottom:7px;">
        <div class="t"><span class="ic">âš¡</span> Executor Instance</div>
        <div class="d">
          Stock OpenCode, execution system prompt, strong model (Sonnet/Opus).
          <span class="tag cyan">tier-1</span> <span class="tag cyan">ephemeral</span> <span class="tag cyan">no fork</span>
          Lower stability priority â€” if it crashes, the Meta-Agent re-dispatches. Treated as ephemeral and replaceable.
          On recovery, the agent continues without knowing it crashed â€” the Context Rebuilder injects a resume prompt
          that makes it look like a natural continuation. External tools, sanitiser required.
          <div class="sep"></div>
          <span class="tag gold">new</span> Reads User KG to respect user preferences during execution (naming conventions, tech choices).
          <span class="tag emerald">new</span> Traverses Code Graph to write structurally coherent code (dependency-aware edits, correct placement).
          Has two escalation tools: <code>request_clarification</code> to pause and ask
          the planner for guidance, and <code>check_escalation_response</code> to poll for an answer.
          The Worker's system prompt says: "If you're uncertain about scope, direction, or trade-offs, use
          request_clarification. Don't guess â€” ask."
        </div>
      </div>
      <div class="sub">
        <div class="sl">Worker MCP Tools (dynamic manifest â€” hot-swappable + escalation + graph reads)</div>
        <div class="row">
          <div class="box b-cyan" style="padding:6px 8px;"><div class="t" style="font-size:8.5px;">ğŸ” search</div><div class="d"><span class="tag red">ext</span></div></div>
          <div class="box b-cyan" style="padding:6px 8px;"><div class="t" style="font-size:8.5px;">âœ‰ email</div><div class="d"><span class="tag red">ext</span></div></div>
          <div class="box b-cyan" style="padding:6px 8px;"><div class="t" style="font-size:8.5px;">ğŸ—„ database</div><div class="d"><span class="tag red">write</span></div></div>
          <div class="box b-cyan" style="padding:6px 8px;"><div class="t" style="font-size:8.5px;">ğŸ“‚ filesystem</div><div class="d"><span class="tag red">write</span></div></div>
          <div class="box b-cyan" style="padding:6px 8px;"><div class="t" style="font-size:8.5px;">ğŸ’» code_exec</div><div class="d"><span class="tag red">write</span></div></div>
          <div class="box b-cyan" style="padding:6px 8px;"><div class="t" style="font-size:8.5px;">ğŸ§© custom *</div><div class="d"><span class="tag green">dynamic</span></div></div>
        </div>
        <div class="row">
          <div class="box b-teal" style="padding:6px 8px;">
            <div class="t" style="font-size:8.5px;">ğŸ™‹ request_clarification</div>
            <div class="d">Writes question + context snapshot to State Store. Sets task status to <code>paused:awaiting_guidance</code>. Worker halts current execution and waits.</div>
          </div>
          <div class="box b-teal" style="padding:6px 8px;">
            <div class="t" style="font-size:8.5px;">ğŸ“¨ check_escalation_response</div>
            <div class="d">Polls State Store for Meta-Agent's response. Returns guidance or <code>still_pending</code>. Worker resumes when guidance arrives.</div>
          </div>
        </div>
        <div class="row">
          <div class="box b-gold" style="padding:6px 8px;"><div class="t" style="font-size:8.5px;">ğŸ‘¤ user_kg_read <span class="nb">new</span></div><div class="d">Read-only. No writes (injection safety).</div></div>
          <div class="box b-emerald" style="padding:6px 8px;"><div class="t" style="font-size:8.5px;">ğŸ—º code_graph_read <span class="nb">new</span></div><div class="d">Read-only. Checkpointer writes on its behalf.</div></div>
        </div>
      </div>
      <div class="callout c-cyan" style="margin-top:8px;">
        <div class="ct">âœ¦ Task Dispatch (from the Worker's perspective)</div>
        <div class="cb">
          The Worker receives tasks as structured system prompt injections:
          <code>phase</code>, <code>task</code>, <code>constraints</code>, <code>forbidden_actions</code>,
          <code>available_tools</code>, <code>success_criteria</code>.
          It doesn't know about the Meta-Agent, goals, self-evolution, or what phase comes next.
          <div class="sep"></div>
          <strong>Single-phase isolation:</strong> The Worker sees "Write failing step tests for this feature file.
          DO NOT implement any production code." It literally cannot skip ahead because it doesn't know what
          "ahead" is. The <code>forbidden_actions</code> field explicitly lists what it must not do (e.g.
          <code>["create production files", "modify existing src/", "run tests in watch mode"]</code>).
          It just executes the current phase and reports results via tool outputs that the Checkpointer captures.
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• ESCALATION FLOW CALLOUT â•â•â•â•â•â•â•â•â•â• -->
  <div class="layer l-teal" data-label="Escalation Flow Â· Worker â†” Meta-Agent Communication" style="padding:16px 16px 14px;">
    <div class="row">
      <div class="box b-teal" style="min-width:100%;">
        <div class="d" style="line-height:1.8;">
          <strong style="color:var(--teal);">The escalation sequence:</strong><br>
          <span style="font-family:'JetBrains Mono',monospace;font-size:8.5px;">
            <span style="color:var(--cyan)">Worker</span> hits ambiguity â†’
            calls <code>request_clarification({question, context, options})</code> â†’
            <span style="color:var(--blue)">State Store</span> records escalation with status <code>pending</code> â†’
            <span style="color:var(--cyan)">Worker</span> pauses (returns control to OpenCode's idle loop) â†’
            <span style="color:var(--orange)">Meta-Agent</span>'s <code>state_reader.get_escalations()</code> picks it up on next planning cycle â†’
            <span style="color:var(--orange)">Meta-Agent</span> reasons about it â†’
            calls <code>worker_control.respond_escalation({task_id, guidance})</code> â†’
            <span style="color:var(--blue)">State Store</span> updates escalation to <code>resolved</code> â†’
            <span style="color:var(--cyan)">Worker</span> calls <code>check_escalation_response()</code> â†’ receives guidance â†’ resumes
          </span>
          <div class="sep"></div>
          <strong style="color:var(--text-dim);font-size:9.5px;">Timeout handling:</strong>
          <span style="font-size:9.5px;color:var(--text-dim);">
            If Meta-Agent doesn't respond within <code>escalation_timeout_ms</code>, the Worker can either:
            (a) proceed with its best guess (configurable), (b) abort the task, or (c) escalate to Human Gate.
            The timeout policy is set in the Worker's system prompt.
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="arrow"><span class="dir">â–¼</span> both instances read/write state store Â· checkpointer updates code graph</div>

  <!-- â•â•â•â•â•â•â•â•â•â• STATE STORE + GRAPH STORES â•â•â•â•â•â•â•â•â•â• -->
  <div class="layer l-blue" data-label="Shared State Store Â· The Bridge">
    <div class="row">
      <div class="box b-blue" style="flex:2;">
        <div class="t"><span class="ic">ğŸ’¾</span> State Store (SQLite WAL / Postgres)</div>
        <div class="d">
          Append-only log that <strong>both instances read/write</strong>. The Meta-Agent writes goals and reads results.
          The Worker's Checkpointer writes tool call logs and progress. This is how the two OpenCode instances
          communicate without direct coupling â€” they share a database, not a connection.
          Also stores <strong>escalation records</strong> (question, context, response, status) and <strong>fast-path completion records</strong>
          so the Meta-Agent stays aware of tasks it didn't plan. Dashboard reads everything here.
        </div>
      </div>
      <div class="box b-blue">
        <div class="t"><span class="ic">ğŸ“¸</span> Checkpointer</div>
        <div class="d">
          Taps Worker's Proxy. Writes after every tool response: task ID, tool name, args, result hash,
          timestamp, plan summary. The Meta-Agent's <code>state_reader</code> tool queries this.
          Also snapshots escalation state so crash recovery can restore a paused-and-waiting Worker correctly.
          <span class="tag emerald">new</span> If tool was a file edit, also triggers AST re-parse and Code Graph update.
          <div class="sep"></div>
          <strong>Strategy:</strong> tool results are facts; LLM reasoning can be re-derived. So we save the facts
          (tool call + result) and let the Context Rebuilder regenerate the reasoning frame on recovery.
          Runs <strong>async</strong> â€” doesn't block the agent. The proxy fires-and-forgets to the checkpointer;
          the Worker never waits for a checkpoint write to complete.
        </div>
      </div>
      <div class="box b-blue">
        <div class="t"><span class="ic">ğŸ“</span> Context Rebuilder</div>
        <div class="d">
          On crash recovery of either instance: generates resume prompt from compressed checkpoint + relevant graph context.
          For Worker: "you were doing X, completed Y, next step Z".
          For Meta-Agent: "current goal is X, worker status is Y, pending goals are Z".
          If Worker was in <code>paused:awaiting_guidance</code> state, resume prompt includes the
          escalation question and any response received while it was down.
          <div class="sep"></div>
          <strong>Lossy by design.</strong> You can't clone LLM hidden state â€” it's non-serialisable.
          This is like a save game, not a VM snapshot. The rebuilt context is "good enough" â€”
          the agent continues without knowing it crashed, picking up from the last checkpoint with
          a compressed summary of what came before.
        </div>
      </div>
    </div>
  </div>

  <div class="arrow"><span class="dir">â–¼</span> proxies connect each instance to its tools</div>

  <!-- â•â•â•â•â•â•â•â•â•â• PROXIES + SANITISER â•â•â•â•â•â•â•â•â•â• -->
  <div class="split" style="margin-bottom:12px;">
    <div class="layer l-orange" data-label="MCP Proxy â‘  Â· Meta-Agent" style="margin-bottom:0;">
      <div class="box b-orange" style="min-width:100%;">
        <div class="t"><span class="ic">â‡„</span> Planning Tools</div>
        <div class="d">
          Hosts 10 planning tools (6 planning + 4 graph). These are <strong>your custom MCP servers</strong> â€” small, stable, purpose-built.
          No external API calls, no injection risk. <span class="tag green">static</span> <span class="tag green">no sanitiser</span>
          <span class="tag green">low risk</span>
        </div>
      </div>
    </div>
    <div class="layer l-cyan" data-label="MCP Proxy â‘¡ Â· Worker (hot-swappable)" style="margin-bottom:0;">
      <div class="box b-cyan" style="min-width:100%;">
        <div class="t"><span class="ic">â‡„</span> Execution Tools + Escalation Tools + Graph Reads</div>
        <div class="d">
          Hosts all external-facing tools + escalation + graph reads. <strong>Dynamic manifest</strong> â€” the Meta-Agent's
          <code>proxy_admin</code> tool adds/removes servers here at runtime. All responses pass through the Sanitiser.
          <strong>Health & circuit breaker:</strong> heartbeats downstream servers; dead endpoints auto-removed from manifest,
          Meta-Agent notified via State Store so it can find replacements.
          <span class="tag red">sanitiser required</span> <span class="tag green">hot-swappable</span> <span class="tag sky">checkpoint tap</span> <span class="tag amber">circuit breaker</span>
        </div>
      </div>
    </div>
  </div>

  <div class="layer l-red" data-label="Security Sandbox Â· Sanitiser (Worker Proxy Only)">
    <div class="row">
      <div class="box b-red" style="flex:2;">
        <div class="t"><span class="ic">ğŸ›¡</span> 3-Stage Sanitiser</div>
        <div class="d">
          Sits between Worker's Proxy and downstream servers.
          <strong>â‘ </strong> Heuristic regex â†’ <strong>â‘¡</strong> Structural strip (role tags, cap length) â†’ <strong>â‘¢</strong> Optional LLM classifier.
          The Meta-Agent's proxy does <strong>NOT</strong> need a sanitiser â€” its tools are all internal, no external input.
          Isolated subprocess. Fail-closed.
          Scans <strong>inbound responses</strong> (injection defence) and <strong>outbound tool args</strong>
          (prevents data exfiltration via a tricked agent â€” e.g. an injected prompt that encodes secrets into a search query).
          Injection events visible in dashboard Security Events panel.
        </div>
      </div>
      <div class="box b-red">
        <div class="t"><span class="ic">ğŸ“‹</span> Alerts â†’ Meta-Agent + Dashboard</div>
        <div class="d">
          Blocked injections logged to State Store. Meta-Agent can auto-disable compromised tools.
          Dashboard shows real-time security events feed.
        </div>
      </div>
    </div>
  </div>

  <div class="arrow"><span class="dir">â–¼</span> worker proxy fans out to downstream</div>

  <div class="layer l-amber" data-label="Downstream MCP Tool Servers Â· External">
    <div class="row">
      <div class="box b-amber"><div class="t"><span class="ic">ğŸ”</span> Search</div></div>
      <div class="box b-amber"><div class="t"><span class="ic">âœ‰</span> Email</div></div>
      <div class="box b-amber"><div class="t"><span class="ic">ğŸ—„</span> DB</div></div>
      <div class="box b-amber"><div class="t"><span class="ic">ğŸ“‚</span> FS</div></div>
      <div class="box b-amber"><div class="t"><span class="ic">ğŸ’»</span> Code</div></div>
      <div class="box b-amber"><div class="t"><span class="ic">ğŸ§©</span> Custom</div></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• NOTES â•â•â•â•â•â•â•â•â•â• -->
  <div class="notes">

    <div class="nc n-gold">
      <h3><span class="ni">ğŸ‘¤</span> User Knowledge Graph â€” What It Solves</h3>
      <ul>
        <li><strong style="color:var(--text)">Personalisation:</strong> "Alice prefers typed SQL over ORMs" â€” Worker respects this without being told every time</li>
        <li><strong style="color:var(--text)">Project awareness:</strong> "acme-saas uses Next.js + Postgres, client needs SOC2" â€” Meta-Agent plans accordingly</li>
        <li><strong style="color:var(--text)">Team context:</strong> "Bob is backend lead, prefers PRs to direct pushes" â€” agents respect team workflow</li>
        <li><strong style="color:var(--text)">Decision memory:</strong> "We decided to use JWT over sessions on Jan 15" â€” prevents revisiting settled decisions</li>
        <li><strong style="color:var(--text)">Convention enforcement:</strong> "No ORMs, minimal comments, Tailwind for styling" â€” consistent output across all tasks</li>
        <li><strong style="color:var(--text)">Deadline awareness:</strong> Meta-Agent can prioritise and scope tasks based on known deadlines</li>
      </ul>
    </div>

    <div class="nc n-emerald">
      <h3><span class="ni">ğŸ—º</span> RPG Code Graph â€” What It Solves</h3>
      <ul>
        <li><strong style="color:var(--text)">Dependency awareness:</strong> Worker knows what imports what before editing â€” avoids breaking coupled files</li>
        <li><strong style="color:var(--text)">Placement decisions:</strong> "where should rate limiting go?" â†’ traverse moduleâ†’fileâ†’function to find the right layer</li>
        <li><strong style="color:var(--text)">Topological code generation:</strong> when building new features, generate in dependency order (leaf deps first)</li>
        <li><strong style="color:var(--text)">Data flow understanding:</strong> inter-module edges show how data moves through the system</li>
        <li><strong style="color:var(--text)">Pattern consistency:</strong> Worker can see existing patterns (class hierarchy, middleware style) and match them</li>
        <li><strong style="color:var(--text)">Blast radius estimation:</strong> Meta-Agent traverses deps to assess risk before assigning edit tasks</li>
      </ul>
    </div>

    <div class="nc n-purple">
      <h3><span class="ni">ğŸ”’</span> Write Permission Matrix</h3>
      <ul>
        <li><strong style="color:var(--gold)">User KG writes:</strong> User (direct edits) + Meta-Agent (inferred from patterns) â€” never Worker</li>
        <li><strong style="color:var(--emerald)">Code Graph writes:</strong> Static analyser (on init) + Checkpointer (after edits) + Meta-Agent (annotations) â€” never Worker directly</li>
        <li><strong style="color:var(--text)">Worker reads both:</strong> traversal queries only â€” cannot poison either graph even if fully compromised by injection</li>
        <li><strong style="color:var(--text)">Confidence layering:</strong> user-explicit (1.0) > meta-agent-inferred (0.8) > auto-extracted (0.6)</li>
      </ul>
    </div>

    <div class="nc n-orange">
      <h3><span class="ni">ğŸ§ </span> How Meta-Agent Uses Both Graphs</h3>
      <ul>
        <li><strong style="color:var(--gold)">Before planning:</strong> "What stack does this project use? Any deadlines? User preferences for this domain?"</li>
        <li><strong style="color:var(--emerald)">Before decomposing coding task:</strong> "Which modules are involved? What's the dependency order? How big is the blast radius?"</li>
        <li><strong style="color:var(--text)">Task dispatch enrichment:</strong> includes relevant User KG context + Code Graph context in the Worker's task prompt</li>
        <li><strong style="color:var(--text)">Tool selection:</strong> User KG says "prefers Brave over Google for search" â†’ Meta-Agent configures proxy accordingly</li>
        <li><strong style="color:var(--gold)">Knowledge curation:</strong> after conversation patterns, writes inferred preferences to User KG</li>
      </ul>
    </div>

    <div class="nc full n-emerald" style="border-color:rgba(16,185,129,0.2);background:var(--surface-2);">
      <h3><span class="ni">ğŸ—º</span> RPG Code Graph â€” Implementation (Lightweight)</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:5px;">
        <div>
          <p style="color:var(--emerald);font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;margin-bottom:3px;">â‘  Initial Build (repo load)</p>
          <ul>
            <li>Run tree-sitter / AST parse on all source files</li>
            <li>Extract: files, imports, exports, classes, functions, types</li>
            <li>Build edges: IMPORTS, EXPORTS, EXTENDS, IMPLEMENTS, CONTAINS</li>
            <li>Infer modules from directory structure</li>
            <li>~seconds for repos under 100K LoC</li>
          </ul>
        </div>
        <div>
          <p style="color:var(--emerald);font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;margin-bottom:3px;">â‘¡ Incremental Update (on edit)</p>
          <ul>
            <li>Checkpointer detects file-edit tool calls</li>
            <li>Re-parses only changed files</li>
            <li>Diffs old vs new: added/removed imports, functions, classes</li>
            <li>Updates graph edges incrementally</li>
            <li>No full re-index needed</li>
          </ul>
        </div>
        <div>
          <p style="color:var(--emerald);font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;margin-bottom:3px;">â‘¢ Query Patterns</p>
          <ul>
            <li><code>topo_order(module)</code> â€” dependency-ordered file list for generation</li>
            <li><code>data_flow(A, B)</code> â€” how data moves between modules</li>
            <li><code>dependents(file)</code> â€” what breaks if this file changes</li>
            <li><code>pattern(type, dir)</code> â€” existing patterns in a directory</li>
            <li><code>where_to_add(capability)</code> â€” suggested file/module for new code</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="nc full" style="border-color:var(--border-accent);background:var(--surface-2);">
      <h3 style="color:var(--text);">ğŸ— Process Tree v3.2 (Final)</h3>
      <div style="font-family:'JetBrains Mono',monospace;font-size:9.5px;color:var(--text-dim);line-height:2;margin-top:6px;padding:10px 14px;background:rgba(0,0,0,0.3);border-radius:5px;overflow-x:auto;">
        <span style="color:var(--purple)">supervisor</span> <span style="color:var(--text-muted)">(PID 1 Â· immortal Â· health API :9100)</span><br>
        <span style="color:var(--text-muted)">â”‚</span><br>
        <span style="color:var(--text-muted)">â”œâ”€â”€</span> <span style="color:var(--sky)">dashboard</span> <span style="color:var(--text-muted)">(web UI on :3000 Â· read-only Â· process view, goals, tools, security, </span><span style="color:var(--gold)">entity explorer</span><span style="color:var(--text-muted)">, </span><span style="color:var(--emerald)">repo map</span><span style="color:var(--text-muted)">)</span><br>
        <span style="color:var(--text-muted)">â”œâ”€â”€</span> <span style="color:var(--lime)">task-router</span> <span style="color:var(--text-muted)">(rule engine Â· fast/full/gated Â· queries user KG for context)</span><br>
        <span style="color:var(--text-muted)">â”‚</span><br>
        <span style="color:var(--text-muted)">â”œâ”€â”€</span> <span style="color:var(--orange)">opencode-meta</span> <span style="color:var(--text-muted)">(planner Â· cheap model Â· reads/writes both graphs)</span><br>
        <span style="color:var(--text-muted)">â”‚&nbsp;&nbsp; â””â”€â”€</span> <span style="color:var(--orange)">mcp-proxy-meta</span> <span style="color:var(--text-muted)">(10 tools: 6 planning + 2 user KG + 2 code graph)</span><br>
        <span style="color:var(--text-muted)">â”‚</span><br>
        <span style="color:var(--text-muted)">â”œâ”€â”€</span> <span style="color:var(--cyan)">opencode-worker</span> <span style="color:var(--text-muted)">(executor Â· strong model Â· reads both graphs, writes neither)</span><br>
        <span style="color:var(--text-muted)">â”‚&nbsp;&nbsp; â””â”€â”€</span> <span style="color:var(--cyan)">mcp-proxy-worker</span> <span style="color:var(--text-muted)">(dynamic tools + escalation + graph reads)</span><br>
        <span style="color:var(--text-muted)">â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”œâ”€â”€</span> <span style="color:var(--red)">sanitiser</span> <span style="color:var(--text-muted)">(isolated Â· fail-closed Â· 3-stage)</span><br>
        <span style="color:var(--text-muted)">â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”œâ”€â”€</span> <span style="color:var(--teal)">mcp-escalation</span> <span style="color:var(--text-muted)">(request_clarification + check_response Â· static)</span><br>
        <span style="color:var(--text-muted)">â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â””â”€â”€</span> <span style="color:var(--amber)">mcp-server-*</span> <span style="color:var(--text-muted)">(downstream Â· external Â· hot-swappable Â· added/removed by meta-agent)</span><br>
        <span style="color:var(--text-muted)">â”‚</span><br>
        <span style="color:var(--text-muted)">â”œâ”€â”€</span> <span style="color:var(--blue)">state-store</span> <span style="color:var(--text-muted)">(SQLite WAL Â· shared Â· goals, tasks, checkpoints, escalations, security events Â· prunable)</span><br>
        <span style="color:var(--text-muted)">â”œâ”€â”€</span> <span style="color:var(--gold)">user-knowledge-graph</span> <span style="color:var(--text-muted)">(SQLite Â· people, projects, preferences, conventions Â· long-lived)</span> <span style="color:var(--gold);font-size:7px;">NEW</span><br>
        <span style="color:var(--text-muted)">â”œâ”€â”€</span> <span style="color:var(--emerald)">code-graph</span> <span style="color:var(--text-muted)">(SQLite Â· files, modules, functions, data flows Â· rebuilt on repo load, incremental on edit)</span> <span style="color:var(--emerald);font-size:7px;">NEW</span><br>
        <span style="color:var(--text-muted)">â””â”€â”€</span> <span style="color:var(--pink)">human-gate</span> <span style="color:var(--text-muted)">(webhook / embedded in dashboard Â· runtime-configurable)</span>
      </div>
    </div>

    <div class="nc n-lime">
      <h3><span class="ni">âš¡</span> Fast Path Design Decisions</h3>
      <ul>
        <li><strong style="color:var(--text)">Classifier is NOT an LLM</strong> â€” it's a rule engine (regex + heuristics on task text) to avoid adding latency</li>
        <li><strong style="color:var(--text)">Signals:</strong> single verb ("format", "lint", "rename"), no conditional language, target file exists, current tools suffice</li>
        <li><strong style="color:var(--text)">Configurable threshold:</strong> set <code>fast_path: "aggressive" | "conservative" | "off"</code> in your DSL</li>
        <li><strong style="color:var(--text)">Meta-Agent stays aware:</strong> fast-path completions are logged to State Store; Meta-Agent reads them on next planning cycle</li>
        <li><strong style="color:var(--text)">Fallback:</strong> if a fast-path task fails, it's re-routed through the Meta-Agent for decomposition</li>
      </ul>
    </div>

    <div class="nc n-teal">
      <h3><span class="ni">ğŸ™‹</span> Escalation Design Decisions</h3>
      <ul>
        <li><strong style="color:var(--text)">Worker stays isolated:</strong> it writes to State Store, not to the Meta-Agent directly â€” no coupling</li>
        <li><strong style="color:var(--text)">Async by design:</strong> Worker pauses, Meta-Agent responds on its own cycle. No blocking RPC.</li>
        <li><strong style="color:var(--text)">Structured payload:</strong> <code>{question, context_snapshot, suggested_options[], urgency}</code></li>
        <li><strong style="color:var(--text)">Timeout policy:</strong> configurable per-task: <code>proceed_best_guess</code>, <code>abort</code>, or <code>escalate_to_human</code></li>
        <li><strong style="color:var(--text)">Crash safety:</strong> Checkpointer snapshots escalation state. On recovery, Worker is told "you asked X, the answer was Y"</li>
        <li><strong style="color:var(--text)">Human fallback:</strong> If Meta-Agent can't resolve, it can forward the escalation to the Human Gate</li>
      </ul>
    </div>

    <div class="nc n-sky">
      <h3><span class="ni">ğŸ“Š</span> Dashboard Data Sources</h3>
      <ul>
        <li><strong style="color:var(--text)">State Store â†’</strong> goals, tasks, tool call logs, escalations, checkpoints, fast-path records, injection events</li>
        <li><strong style="color:var(--text)">Supervisor Health API â†’</strong> process status, uptime, restart count, memory, current model per instance</li>
        <li><strong style="color:var(--text)">No direct process inspection</strong> â€” dashboard never connects to OpenCode or proxies directly</li>
        <li><strong style="color:var(--text)">Push vs Poll:</strong> SSE from State Store for live updates; poll Supervisor health every 5s</li>
        <li><strong style="color:var(--text)">Human Gate embedded:</strong> approval buttons for gated tasks + escalation responses in the same UI</li>
      </ul>
    </div>

    <div class="nc n-orange">
      <h3><span class="ni">â‘ </span> Why Two OpenCode Instances?</h3>
      <ul>
        <li><strong style="color:var(--text)">Separation of concerns:</strong> Planning and execution have different tool sets, models, cost profiles, and risk levels</li>
        <li><strong style="color:var(--text)">Blast radius:</strong> A prompt injection in the Worker can't reach the Planner â€” they share no tools or MCP connection</li>
        <li><strong style="color:var(--text)">Independent recovery:</strong> Worker can crash and be re-dispatched without losing the Meta-Agent's plan state</li>
        <li><strong style="color:var(--text)">Cost optimisation:</strong> Planner uses cheap/fast model (Haiku/Sonnet), Worker uses capable model (Sonnet/Opus)</li>
        <li><strong style="color:var(--text)">Dogfooding:</strong> You build one runtime, not two systems. Both instances use the same config DSL, proxy, and checkpoint infra</li>
      </ul>
    </div>

    <div class="nc n-purple">
      <h3><span class="ni">â‘¡</span> Stability Hierarchy</h3>
      <ul>
        <li><strong style="color:var(--text)">Tier âˆ â€” Supervisor:</strong> No LLM, no external I/O, almost nothing to fail. If it dies, systemd/Docker restarts it</li>
        <li><strong style="color:var(--text)">Tier 0 â€” Meta-Agent:</strong> Only internal tools, no injection surface. Recovered first. Cheap model = fast restart</li>
        <li><strong style="color:var(--text)">Tier 1 â€” Worker:</strong> External tools, high injection risk. Recovered second. Expendable â€” Meta-Agent re-dispatches</li>
        <li><strong style="color:var(--text)">Recovery order:</strong> Supervisor â†’ Meta-Agent â†’ Worker. Each tier can recover the one below it</li>
      </ul>
    </div>

    <div class="nc n-red">
      <h3><span class="ni">ğŸ”’</span> Security Model</h3>
      <ul>
        <li><strong style="color:var(--text)">Meta-Agent:</strong> no sanitiser (internal tools only, no external input)</li>
        <li><strong style="color:var(--text)">Worker:</strong> full 3-stage sanitiser on all external tool responses</li>
        <li><strong style="color:var(--text)">Cross-instance isolation:</strong> Worker cannot reach Meta-Agent's tools even if fully compromised</li>
        <li><strong style="color:var(--text)">Escalation tools are safe:</strong> they write structured data to State Store, not free-text to the Meta-Agent's prompt</li>
        <li><strong style="color:var(--text)">Dashboard:</strong> read-only â€” cannot be used as an attack vector to mutate system state</li>
        <li><strong style="color:var(--text)">Graph writes:</strong> Worker cannot write to either graph â€” even if fully compromised by injection, cannot poison knowledge</li>
      </ul>
    </div>

    <div class="nc full n-lime" style="border-color:rgba(163,230,53,0.18);">
      <h3><span class="ni">âˆ‘</span> Three Stores, Three Purposes</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:5px;">
        <div>
          <p style="color:var(--blue);font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;margin-bottom:3px;">State Store (operational)</p>
          <ul>
            <li>What's happening right now</li>
            <li>Tasks, tool logs, checkpoints, escalations</li>
            <li>High write throughput, simple queries</li>
            <li>Prunable (keep last N days)</li>
            <li>Used for: crash recovery, coordination</li>
          </ul>
        </div>
        <div>
          <p style="color:var(--gold);font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;margin-bottom:3px;">User Knowledge Graph (domain)</p>
          <ul>
            <li>Who you are, what you care about</li>
            <li>People, projects, preferences, rules</li>
            <li>Low write, rich traversal queries</li>
            <li>Grows over time â€” long-lived</li>
            <li>Used for: personalisation, planning context</li>
          </ul>
        </div>
        <div>
          <p style="color:var(--emerald);font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;margin-bottom:3px;">Code Graph (repo structure)</p>
          <ul>
            <li>What the codebase looks like</li>
            <li>Files, modules, deps, data flows</li>
            <li>Rebuilt on load, incremental on edit</li>
            <li>Disposable â€” can always re-derive from code</li>
            <li>Used for: code quality, structural coherence</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="nc n-teal">
      <h3><span class="ni">â‘¢</span> The "Task Decomposer" Is Just a Tool â€” But It Enforces BDD/TDD</h3>
      <ul>
        <li>The Meta-Agent doesn't have a magic "decompose" function â€” it has <code>goal_queue.push</code> and the LLM's own reasoning</li>
        <li>But decomposition follows a <strong>strict BDD/TDD phase pipeline</strong>: "Build auth module" â†’ Meta-Agent pushes an ordered sequence of <em>phase-locked</em> tasks, not a bag of sub-tasks</li>
        <li>Each dispatch to the Worker is a <strong>single phase</strong> with hard boundaries: "Write the feature file â€” DO NOTHING ELSE"</li>
        <li><strong>Why:</strong> LLM agents naturally skip steps or go backwards. They'll start implementing before writing tests, or refactor mid-red. Phase isolation prevents this â€” the Worker literally cannot see the next phase until the current one passes the Meta-Agent's gate</li>
        <li>The <code>worker_control.dispatch_task</code> tool takes a structured task with <code>phase</code>, <code>constraints</code>, and <code>forbidden_actions</code> and injects it into the Worker's system prompt</li>
        <li>The Meta-Agent observes results via <code>state_reader</code>, verifies the phase gate (e.g. "do failing tests exist?"), then dispatches the next phase â€” or re-dispatches the current one if the Worker strayed</li>
        <li>Self-evolution = Meta-Agent using <code>proxy_admin</code> + <code>config_mutator</code> + <code>tool_registry</code> between tasks</li>
      </ul>
    </div>

    <div class="nc full n-teal" style="border-color:rgba(45,212,191,0.2);background:var(--surface-2);">
      <h3><span class="ni">ğŸ”„</span> BDD/TDD Phase Pipeline â€” Why Phase Isolation Matters</h3>
      <p style="margin-top:4px;margin-bottom:8px;">
        LLM agents are bad at process discipline. Given "build a login feature", they'll jump straight to implementation,
        skip tests, or refactor before they've proven anything works. The Meta-Agent solves this by decomposing coding goals
        into a <strong>strict phase pipeline</strong> where each dispatch is a single, isolated step. The Worker never sees
        the full pipeline â€” only the current phase. <strong>Every phase ends with a git commit</strong> â€” creating a clean
        rollback point and an auditable trail of exactly what changed at each step.
      </p>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:6px;">
        <div style="background:rgba(232,185,49,0.06);border:1px solid rgba(232,185,49,0.2);border-radius:4px;padding:7px 8px;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;color:var(--gold);margin-bottom:3px;">â‘  FEATURE</div>
          <div style="font-size:8.5px;color:var(--text-dim);line-height:1.5;">
            "Write the <code>.feature</code> file. Describe the behaviour in Gherkin. <strong>DO NOT</strong> write any tests or code."
            <div style="margin-top:3px;"><span style="font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--lime);background:rgba(163,230,53,0.08);padding:1px 4px;border-radius:2px;">git commit</span> <span style="font-size:7.5px;color:var(--text-muted);">â†’ gate: .feature exists?</span></div>
          </div>
        </div>
        <div style="background:rgba(34,211,238,0.06);border:1px solid rgba(34,211,238,0.2);border-radius:4px;padding:7px 8px;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;color:var(--cyan);margin-bottom:3px;">â‘¡ STEP TESTS</div>
          <div style="font-size:8.5px;color:var(--text-dim);line-height:1.5;">
            "Write failing step definitions for this feature file. <strong>DO NOT</strong> implement any production code."
            <div style="margin-top:3px;"><span style="font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--lime);background:rgba(163,230,53,0.08);padding:1px 4px;border-radius:2px;">git commit</span> <span style="font-size:7.5px;color:var(--text-muted);">â†’ gate: step files exist?</span></div>
          </div>
        </div>
        <div style="background:rgba(167,139,250,0.06);border:1px solid rgba(167,139,250,0.2);border-radius:4px;padding:7px 8px;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;color:var(--purple);margin-bottom:3px;">â‘¢ UNIT TESTS</div>
          <div style="font-size:8.5px;color:var(--text-dim);line-height:1.5;">
            "Write failing unit tests for the components you'll need. <strong>DO NOT</strong> implement any production code."
            <div style="margin-top:3px;"><span style="font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--lime);background:rgba(163,230,53,0.08);padding:1px 4px;border-radius:2px;">git commit</span> <span style="font-size:7.5px;color:var(--text-muted);">â†’ gate: test files exist?</span></div>
          </div>
        </div>
        <div style="background:rgba(248,113,113,0.06);border:1px solid rgba(248,113,113,0.2);border-radius:4px;padding:7px 8px;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;color:var(--red);margin-bottom:3px;">â‘£ RED</div>
          <div style="font-size:8.5px;color:var(--text-dim);line-height:1.5;">
            "Run all tests. Confirm they fail. Report which tests fail and why. <strong>DO NOT</strong> fix anything."
            <div style="margin-top:3px;"><span style="font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--lime);background:rgba(163,230,53,0.08);padding:1px 4px;border-radius:2px;">git commit</span> <span style="font-size:7.5px;color:var(--text-muted);">â†’ gate: tests fail?</span></div>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:6px;">
        <div style="background:rgba(52,211,153,0.06);border:1px solid rgba(52,211,153,0.2);border-radius:4px;padding:7px 8px;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;color:var(--green);margin-bottom:3px;">â‘¤ GREEN</div>
          <div style="font-size:8.5px;color:var(--text-dim);line-height:1.5;">
            "Write the minimum production code to make all tests pass. <strong>DO NOT</strong> refactor or optimise."
            <div style="margin-top:3px;"><span style="font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--lime);background:rgba(163,230,53,0.08);padding:1px 4px;border-radius:2px;">git commit</span> <span style="font-size:7.5px;color:var(--text-muted);">â†’ gate: tests pass?</span></div>
          </div>
        </div>
        <div style="background:rgba(56,189,248,0.06);border:1px solid rgba(56,189,248,0.2);border-radius:4px;padding:7px 8px;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;color:var(--sky);margin-bottom:3px;">â‘¥ REFACTOR</div>
          <div style="font-size:8.5px;color:var(--text-dim);line-height:1.5;">
            "Refactor for clarity, DRY, naming. All tests must still pass. <strong>DO NOT</strong> add new functionality."
            <div style="margin-top:3px;"><span style="font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--lime);background:rgba(163,230,53,0.08);padding:1px 4px;border-radius:2px;">git commit</span> <span style="font-size:7.5px;color:var(--text-muted);">â†’ gate: tests still pass?</span></div>
          </div>
        </div>
        <div style="background:rgba(251,146,60,0.06);border:1px solid rgba(251,146,60,0.2);border-radius:4px;padding:7px 8px;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;color:var(--orange);margin-bottom:3px;">â‘¦ ARCH REVIEW</div>
          <div style="font-size:8.5px;color:var(--text-dim);line-height:1.5;">
            "Audit against Clean Architecture standards. Report violations: dependency direction, layer leaks, abstraction gaps. <strong>DO NOT</strong> fix â€” only report."
            <div style="margin-top:3px;"><span style="font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--lime);background:rgba(163,230,53,0.08);padding:1px 4px;border-radius:2px;">git commit</span> <span style="font-size:7.5px;color:var(--text-muted);">â†’ gate: 0 violations?</span></div>
          </div>
        </div>
        <div style="background:rgba(251,113,133,0.06);border:1px solid rgba(251,113,133,0.2);border-radius:4px;padding:7px 8px;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;color:var(--rose);margin-bottom:3px;">â‘§ SEC REVIEW</div>
          <div style="font-size:8.5px;color:var(--text-dim);line-height:1.5;">
            "Run security analysis. Check: injection vectors, auth gaps, secrets exposure, unsafe dependencies. <strong>DO NOT</strong> fix â€” only report."
            <div style="margin-top:3px;"><span style="font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--lime);background:rgba(163,230,53,0.08);padding:1px 4px;border-radius:2px;">git commit</span> <span style="font-size:7.5px;color:var(--text-muted);">â†’ gate: 0 findings?</span></div>
          </div>
        </div>
      </div>
      <div style="margin-top:10px;font-size:9.5px;color:var(--text-dim);line-height:1.6;">
        <strong style="color:var(--teal)">Phase gates:</strong> Every phase ends with a
        <span style="font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--lime);background:rgba(163,230,53,0.08);padding:1px 4px;border-radius:2px;">git commit</span>
        then the Meta-Agent verifies the gate before advancing.
        If a gate fails, the Meta-Agent re-dispatches the same phase (not the next one) â€” the commit
        is already there as a rollback point if needed.
        Violations from
        <span class="tag orange" style="font-size:7.5px;">â‘¦</span> <span class="tag rose" style="font-size:7.5px;">â‘§</span>
        feed back into the pipeline â€” the Meta-Agent dispatches targeted fix phases,
        then re-runs the review that failed.
        <br><br>
        <strong style="color:var(--teal)">The key insight:</strong> The Worker can't skip ahead because it doesn't know what "ahead" is.
        It receives "write failing step tests" â€” it has no idea that implementation comes later.
        The <code>forbidden_actions</code> field in the dispatch explicitly blocks forward-leaking behaviour.
        This turns the Meta-Agent into a <strong>process enforcer</strong>, not just a task decomposer.
        <br><br>
        <strong style="color:var(--teal)">Review phases are audits, not fixes:</strong> â‘¦ and â‘§ are dispatched as read-only inspections.
        The Worker reports violations but is forbidden from modifying code. The Meta-Agent reads the report,
        then dispatches a separate fix phase with the specific violations as constraints. This prevents the
        "fix one thing, break another" cascade that LLMs produce when given audit + fix in the same prompt.
      </div>
    </div>

    <div class="nc full n-orange" style="border-color:rgba(251,146,60,0.2);background:var(--surface-2);">
      <h3><span class="ni">ğŸ›</span> Standards Enforcement â€” Audit Agents, Not Lint Rules</h3>
      <p style="margin-top:4px;margin-bottom:8px;">
        Phases â‘¦ and â‘§ aren't linters â€” they're <strong>LLM-driven audit agents</strong>. They receive the same
        phase-locked dispatch as any other step, but their prompt is "review this code against standard X â€” report
        violations, DO NOT fix anything." This is more powerful than static analysis because the agent can reason
        about <em>intent</em>, not just syntax.
      </p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div>
          <p style="color:var(--orange);font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;margin-bottom:3px;">â‘¦ Clean Architecture Review</p>
          <ul>
            <li><strong style="color:var(--text)">Dependency direction:</strong> do inner layers import outer layers? (domain â†’ infra = violation)</li>
            <li><strong style="color:var(--text)">Layer boundaries:</strong> is business logic in controllers? Is HTTP in the domain layer?</li>
            <li><strong style="color:var(--text)">Abstraction leaks:</strong> do interfaces leak implementation details? (e.g. SQL in a repository interface)</li>
            <li><strong style="color:var(--text)">Use case isolation:</strong> does each use case have a single responsibility? Cross-cutting concerns separated?</li>
            <li><strong style="color:var(--text)">Code Graph integration:</strong> traverses <code>DATA_FLOW</code> and <code>IMPORTS</code> edges to verify dependency direction structurally, not just by reading files</li>
          </ul>
        </div>
        <div>
          <p style="color:var(--rose);font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;margin-bottom:3px;">â‘§ Security Review</p>
          <ul>
            <li><strong style="color:var(--text)">Injection vectors:</strong> SQL injection, XSS, command injection, path traversal in new code</li>
            <li><strong style="color:var(--text)">Auth / authz gaps:</strong> endpoints without auth middleware, missing permission checks, privilege escalation paths</li>
            <li><strong style="color:var(--text)">Secrets exposure:</strong> hardcoded keys, tokens in logs, secrets in error messages, <code>.env</code> leaks</li>
            <li><strong style="color:var(--text)">Unsafe dependencies:</strong> known CVEs in new imports, deprecated crypto, insecure defaults</li>
            <li><strong style="color:var(--text)">User KG integration:</strong> checks compliance requirements from the knowledge graph (e.g. "client requires SOC2" â†’ enforce specific controls)</li>
          </ul>
        </div>
      </div>
      <div style="margin-top:8px;font-size:9.5px;color:var(--text-dim);line-height:1.6;">
        <strong style="color:var(--orange)">Report format:</strong> Each review produces a structured report:
        <code>{violations: [{file, line, rule, severity, explanation}], passed: bool}</code>.
        The Meta-Agent reads the report. If <code>passed: false</code>, it dispatches targeted fix phases
        (one per violation cluster), then re-runs the failed review. No fix-and-review in the same dispatch.
        <br>
        <strong style="color:var(--orange)">Extensible:</strong> These are just prompt templates. You can add more review phases â€”
        performance review, accessibility audit, API design review â€” same pattern: audit-only dispatch â†’ report â†’ fix cycle.
      </div>
    </div>

    <div class="nc full n-lime" style="border-color:rgba(163,230,53,0.2);">
      <h3><span class="ni">âš¡</span> The Elegance of Dogfooding</h3>
      <p style="margin-top:4px;">
        Because the Meta-Agent is just another OpenCode instance, you get crash recovery, checkpointing, config-as-code,
        and the MCP proxy pattern <strong>for free</strong>. You don't build a bespoke orchestrator â€” you build small MCP
        tool servers and let OpenCode's own agent loop do the planning. The "self-evolution" isn't a special feature â€”
        it's just what happens when you give a planner agent tools that control another agent's configuration.
        The task decomposer is the LLM itself, guided by a system prompt and tools.
      </p>
    </div>

    <div class="nc n-blue">
      <h3><span class="ni">ğŸ’¾</span> Context Preservation Strategy</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:4px;">
        <div>
          <p style="color:var(--green);font-family:'JetBrains Mono',monospace;font-size:8.5px;font-weight:600;margin-bottom:3px;">What IS saved</p>
          <ul>
            <li>Task ID + current step index</li>
            <li>Tool call log (name, args, result hash)</li>
            <li>Plan summary (goal queue snapshot)</li>
            <li>Goal queue pointer (where we are in the plan)</li>
            <li>Timestamps (for ordering and dedup)</li>
            <li>Escalation state (question + response if any)</li>
          </ul>
        </div>
        <div>
          <p style="color:var(--red);font-family:'JetBrains Mono',monospace;font-size:8.5px;font-weight:600;margin-bottom:3px;">What is NOT saved</p>
          <ul>
            <li>LLM hidden state â€” non-serialisable</li>
            <li>Full conversation history â€” too large</li>
            <li>In-flight reasoning â€” ephemeral by nature</li>
            <li>Reconstructed as "good enough" context from saved facts</li>
            <li>Tool results are facts; LLM reasoning can be re-derived</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="nc n-purple">
      <h3><span class="ni">ğŸ”„</span> Crash Recovery Flow</h3>
      <ul>
        <li><strong style="color:var(--text)">â‘  Detect:</strong> <code>waitpid()</code> returns instantly on exit; liveness probe catches hangs (no output for <code>timeout_ms</code>)</li>
        <li><strong style="color:var(--text)">â‘¡ Assess:</strong> Was it mid-tool-call or between tasks? Checkpointer's last entry tells us</li>
        <li><strong style="color:var(--text)">â‘¢ Rebuild:</strong> Context Rebuilder generates a resume prompt from the checkpoint + graph context</li>
        <li><strong style="color:var(--text)">â‘£ Respawn:</strong> Fresh process, new PID, same config (rebuilt via DSL). Resume prompt injected as system context</li>
        <li><strong style="color:var(--text)">â‘¤ Idempotency:</strong> Completed tool calls are marked in the checkpoint; the resumed agent skips them. Avoids double-writes</li>
        <li><strong style="color:var(--text)">â‘¥ Backoff:</strong> Exponential delay between retries. After 5 failures â†’ alert Human Gate, halt the instance</li>
      </ul>
    </div>

    <div class="nc n-orange">
      <h3><span class="ni">ğŸ”§</span> Self-Evolution Mechanics</h3>
      <ul>
        <li><strong style="color:var(--text)">Tool discovery:</strong> Meta-Agent's <code>tool_registry.search</code> finds new MCP servers from a catalogue; <code>proxy_admin.register</code> hot-adds them to the Worker's manifest</li>
        <li><strong style="color:var(--text)">Config mutation via DSL, not JSON:</strong> the <code>config_mutator</code> uses a typed builder DSL â€” validated, versioned, rollback-safe. Not raw JSON editing</li>
        <li><strong style="color:var(--text)">Sub-goal generation:</strong> Meta-Agent decomposes high-level goals into sub-tasks, pushes them to the goal queue. The Worker never sees the parent goal</li>
        <li><strong style="color:var(--text)">Prompt evolution:</strong> Meta-Agent can update the Worker's system prompt between runs to refine behaviour based on observed results</li>
        <li><strong style="color:var(--text)">Guardrails:</strong> budget limits (max cost per goal), scope limits (max sub-tasks per decomposition), allowed tool categories, model whitelist</li>
      </ul>
    </div>

    <div class="nc n-red">
      <h3><span class="ni">ğŸ”¥</span> Security in Full-Auto Mode</h3>
      <ul>
        <li><strong style="color:var(--text)">Sanitiser is critical path:</strong> in full-auto, no human reviews tool calls â€” the sanitiser is the only defence against prompt injection in external responses</li>
        <li><strong style="color:var(--text)">Write fence still applies:</strong> even in full-auto, destructive ops (DB drops, prod deploys) require Human Gate approval</li>
        <li><strong style="color:var(--text)">Injection feedback loop:</strong> Meta-Agent reads sanitiser alerts from State Store and can auto-disable compromised tools, learning to avoid them</li>
        <li><strong style="color:var(--text)">Kill switch:</strong> Supervisor's <code>/stop</code> endpoint + <code>SIGTERM</code> handler â†’ instant halt. Emergency brake for runaway agents</li>
        <li><strong style="color:var(--text)">Blast radius:</strong> each run is a fresh process with scoped permissions. No state drift between runs. Worker can't access Planner's tools even if fully compromised</li>
      </ul>
    </div>

    <div class="nc n-purple">
      <h3><span class="ni">âš¡</span> Why a Supervisor, Not a Cron Job?</h3>
      <ul>
        <li><strong style="color:var(--text)">Instant detection:</strong> <code>waitpid()</code> returns the moment a child exits. Cron's worst-case latency = poll interval (could be minutes)</li>
        <li><strong style="color:var(--text)">Crash loop handling:</strong> Supervisor tracks restart count + applies exponential backoff. Cron would blindly restart on every tick</li>
        <li><strong style="color:var(--text)">Multi-step recovery:</strong> Supervisor sequences: kill â†’ checkpoint read â†’ config rebuild â†’ context inject â†’ respawn. Cron can only do "start the thing"</li>
        <li><strong style="color:var(--text)">Lifecycle ownership:</strong> Supervisor owns the full process tree. It knows which children are alive, their PIDs, their health. Cron has no state between runs</li>
        <li><strong style="color:var(--text)">Signal handling:</strong> Supervisor catches SIGTERM/SIGCHLD and coordinates graceful shutdown of all children. Cron can't do inter-process coordination</li>
      </ul>
    </div>

    <div class="nc full n-purple" style="border-color:rgba(167,139,250,0.2);">
      <h3><span class="ni">âˆ‘</span> Architecture Summary â€” What You Build</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:5px;">
        <div>
          <p style="color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;margin-bottom:3px;">You build (custom code)</p>
          <ul>
            <li>Supervisor (process manager)</li>
            <li>Config DSL (typed builder)</li>
            <li>6 Meta-Agent MCP tool servers</li>
            <li>4 Graph MCP tool servers (2 user KG + 2 code graph)</li>
            <li>2 Worker escalation MCP tools</li>
            <li>Task router (rule engine)</li>
            <li>Sanitiser (3-stage pipeline)</li>
            <li>Dashboard (web UI)</li>
            <li>Checkpointer + Context Rebuilder</li>
            <li>User Knowledge Graph store</li>
            <li>Code Graph builder (AST parser)</li>
            <li>Standards enforcement prompts (arch + security review templates)</li>
          </ul>
        </div>
        <div>
          <p style="color:var(--cyan);font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;margin-bottom:3px;">You use unmodified</p>
          <ul>
            <li>OpenCode (2 instances)</li>
            <li>Downstream MCP servers</li>
            <li>SQLite / Postgres</li>
            <li>tree-sitter (AST parsing)</li>
          </ul>
        </div>
        <div>
          <p style="color:var(--lime);font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;margin-bottom:3px;">Emergent (not built â€” falls out)</p>
          <ul>
            <li>Task decomposition (LLM + tools)</li>
            <li>Self-evolution (planner + config tools)</li>
            <li>Crash recovery (checkpoints + resume)</li>
            <li>Hot-swap tooling (proxy indirection)</li>
            <li>Worker â†” Planner communication</li>
            <li>Preference learning (Meta-Agent + User KG)</li>
            <li>Structural code coherence (Worker + Code Graph)</li>
            <li>BDD/TDD discipline (phase-locked dispatch)</li>
            <li>Standards enforcement (audit â†’ fix â†’ re-audit loop)</li>
          </ul>
        </div>
      </div>
    </div>

  </div>

  </div><!-- /view-detail -->

</div>

<script>
function toggleView(view) {
  const body = document.body;
  const topBtns = document.querySelectorAll('.view-toggle .view-btn');
  if (view === 'detail') {
    body.classList.add('show-detail');
  } else {
    body.classList.remove('show-detail');
  }
  topBtns.forEach(btn => {
    btn.classList.remove('active');
    const text = btn.textContent.trim().toLowerCase();
    if ((view === 'overview' && text === 'overview') || (view === 'detail' && text === 'detailed view')) {
      btn.classList.add('active');
    }
  });
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>
</body>
</html>