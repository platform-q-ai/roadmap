<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Living View — Open Autonomous Runtime</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/cytoscape@3.30.4/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
<script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@15.0.7/marked.min.js" integrity="sha384-H+hy9ULve6xfxRkWIh/YOtvDdpXgV2fmAGQkIDTxIgZwNoaoBal14Di2YTMR6MzR" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js" integrity="sha384-eEu5CTj3qGvu9PdJuS+YlkNi7d2XxQROAFYOr59zgObtlcux1ae1Il3u7jvdCSWu" crossorigin="anonymous"></script>
<style>
:root {
  --bg:#07080c;--surface:#0f1219;--surface-2:#171b25;--border:#262c3c;--border-accent:#384058;
  --text:#dfe2ea;--text-dim:#7a8099;--text-muted:#4a5068;
  --blue:#4d8bff;--cyan:#22d3ee;--green:#34d399;--amber:#fbbf24;--red:#f87171;
  --purple:#a78bfa;--pink:#f472b6;--orange:#fb923c;--lime:#a3e635;--teal:#2dd4bf;
  --sky:#38bdf8;--gold:#e8b931;--indigo:#818cf8;--rose:#fb7185;--emerald:#10b981;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;}
.canvas{max-width:1440px;margin:0 auto;padding:36px 22px 80px;}

/* ─── Header ──────────────────────────────────────────── */
.header{text-align:center;margin-bottom:32px;}
.header h1{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:27px;letter-spacing:-0.5px;margin-bottom:7px;}
.header h1 .hl{color:var(--cyan);}
.header h1 .v{color:var(--gold);font-size:17.5px;}
.header p{font-size:15px;color:var(--text-dim);max-width:840px;margin:0 auto;line-height:1.65;}

/* ─── Version Toggle ──────────────────────────────────── */
.version-strip{display:flex;gap:0;margin-top:8px;border-radius:4px;overflow:hidden;border:1px solid var(--border);width:fit-content;}
.version-btn{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;padding:5px 12px;background:var(--surface);color:var(--text-muted);border:none;cursor:pointer;transition:all 0.12s ease;display:flex;align-items:center;gap:4px;border-right:1px solid var(--border);}
.version-btn:last-child{border-right:none;}
.version-btn:hover{color:var(--text-dim);background:var(--surface-2);}
.version-btn.active{background:var(--cyan);color:var(--bg);cursor:default;}
.version-btn.active.status-planned{background:var(--text-muted);}
.version-btn.active.status-in-progress{background:var(--blue);}
.version-btn.active.status-complete{background:var(--green);}

/* ─── Progress Badge ──────────────────────────────────── */
.progress-badge{display:inline-flex;align-items:center;gap:4px;font-family:'JetBrains Mono',monospace;font-size:9.5px;font-weight:600;padding:2px 6px;border-radius:3px;margin-left:auto;}
.progress-badge.planned{background:rgba(255,255,255,0.04);color:var(--text-muted);border:1px solid rgba(255,255,255,0.06);}
.progress-badge.in-progress{background:rgba(77,139,255,0.1);color:var(--blue);border:1px solid rgba(77,139,255,0.2);}
.progress-badge.complete{background:rgba(52,211,153,0.1);color:var(--green);border:1px solid rgba(52,211,153,0.2);}

.progress-bar{width:48px;height:4px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden;}
.progress-bar-fill{height:100%;border-radius:2px;transition:width 0.3s ease;}
.progress-bar-fill.planned{background:var(--text-muted);}
.progress-bar-fill.in-progress{background:var(--blue);}
.progress-bar-fill.complete{background:var(--green);}

/* ─── Expanded Content ────────────────────────────────── */
.version-content{margin-top:8px;padding:10px 12px;background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:4px;font-size:12px;color:var(--text-dim);line-height:1.7;}
.version-content p{margin-bottom:6px;}

/* ─── Feature Files ───────────────────────────────────── */
.features-section{margin-top:8px;}
.features-header{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-muted);margin-bottom:4px;cursor:pointer;display:flex;align-items:center;gap:4px;}
.features-header:hover{color:var(--text-dim);}
.features-header .arrow{transition:transform 0.15s ease;font-size:9px;}
.features-header .arrow.open{transform:rotate(90deg);}
.feature-file{background:rgba(0,0,0,0.25);border:1px solid var(--border);border-radius:4px;padding:8px 10px;margin-top:4px;}
.feature-file .ff-title{font-family:'JetBrains Mono',monospace;font-size:10.5px;font-weight:600;color:var(--teal);margin-bottom:3px;}
.feature-file pre{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);line-height:1.6;white-space:pre-wrap;overflow-x:auto;max-height:300px;overflow-y:auto;}

/* ─── Progression Tree ────────────────────────────────── */
#progression-container{width:100%;height:600px;background:var(--surface);border:1px solid var(--border);border-radius:7px;position:relative;cursor:pointer;}
.state-concept{color:var(--text-muted);}
.state-mvp{color:var(--amber);}
.state-released{color:var(--green);}

/* ─── Component Dialog ────────────────────────────────── */
.dialog-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.dialog-overlay.open{display:flex;}
.dialog-box{background:var(--surface);border:1px solid var(--border-accent);border-radius:8px;width:90%;max-width:640px;max-height:80vh;overflow-y:auto;padding:24px 28px;position:relative;box-shadow:0 20px 60px rgba(0,0,0,0.5);}
.dialog-close{position:absolute;top:12px;right:14px;background:none;border:1px solid var(--border);border-radius:4px;color:var(--text-dim);font-size:14px;cursor:pointer;width:28px;height:28px;display:flex;align-items:center;justify-content:center;transition:all 0.12s ease;}
.dialog-close:hover{color:var(--text);border-color:var(--border-accent);background:var(--surface-2);}
.dialog-header{margin-bottom:12px;}
.dialog-header .dialog-title{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:18px;display:flex;align-items:center;gap:8px;padding-right:40px;}
.dialog-header .dialog-state{font-family:'JetBrains Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:0.8px;margin-top:4px;}
.dialog-header .dialog-desc{font-size:13px;color:var(--text-dim);line-height:1.6;margin-top:8px;}
.dialog-body{margin-top:12px;}

/* ─── Markdown Content ─────────────────────────────────── */
.md-content{font-size:inherit;line-height:1.6;color:inherit;}
.md-content p{margin:0 0 0.4em;}
.md-content p:last-child{margin-bottom:0;}
.md-content h1,.md-content h2,.md-content h3,.md-content h4{font-family:'JetBrains Mono',monospace;margin:0.6em 0 0.3em;line-height:1.3;}
.md-content h1{font-size:1.15em;} .md-content h2{font-size:1.05em;} .md-content h3{font-size:1em;}
.md-content strong,.md-content b{color:var(--text);font-weight:600;}
.md-content em,.md-content i{color:var(--text-dim);font-style:italic;}
.md-content ul,.md-content ol{margin:0.3em 0 0.5em 1.4em;padding:0;}
.md-content li{margin:0.15em 0;line-height:1.5;}
.md-content code{font-family:'JetBrains Mono',monospace;font-size:0.88em;background:var(--surface-2);border:1px solid var(--border);border-radius:3px;padding:1px 5px;color:var(--cyan);}
.md-content pre{background:var(--surface-2);border:1px solid var(--border);border-radius:5px;padding:8px 12px;margin:0.4em 0;overflow-x:auto;}
.md-content pre code{background:none;border:none;padding:0;font-size:0.85em;color:var(--text);}
.md-content blockquote{border-left:3px solid var(--border-accent);margin:0.4em 0;padding:0.3em 0 0.3em 12px;color:var(--text-dim);font-style:italic;}
.md-content a{color:var(--blue);text-decoration:none;} .md-content a:hover{text-decoration:underline;}
.md-content hr{border:none;border-top:1px solid var(--border);margin:0.6em 0;}
.md-content table{border-collapse:collapse;margin:0.4em 0;width:100%;}
.md-content th,.md-content td{border:1px solid var(--border);padding:4px 8px;font-size:0.9em;text-align:left;}
.md-content th{background:var(--surface-2);font-weight:600;}

/* ─── Drag and Drop Cursor Styles ───────────────────── */
#progression-container .grab{cursor:grab!important;}
#progression-container .grabbing{cursor:grabbing!important;}

/* ─── Responsive ──────────────────────────────────────── */
@media(max-width:900px){
  .canvas{padding:18px 12px 60px;}
}
</style>
</head>
<body>
<div class="canvas" id="app">
  <div class="header">
    <h1>Open <span class="hl">Autonomous Runtime</span> <span class="v">v0.3</span></h1>
    <p>Living architecture documentation. Each component has versioned specs (Overview → MVP → v1 → v2) with Gherkin feature files. Click any component to explore its documentation and build progress.</p>
  </div>

  <div id="progression-container"></div>
</div>

<div class="dialog-overlay" id="dialog-overlay" onclick="onOverlayClick(event)">
  <div class="dialog-box" id="dialog-box">
    <button class="dialog-close" onclick="closeDialog()">&times;</button>
    <div class="dialog-header" id="dialog-header"></div>
    <div class="dialog-body" id="dialog-body"></div>
  </div>
</div>

<script>
// ─── State ───────────────────────────────────────────────
let DATA = null;

// ─── Render ──────────────────────────────────────────────
function getNodeById(id) {
  return DATA.nodes.find(n => n.id === id);
}

function renderProgressBadge(version) {
  if (!version) return '<span class="progress-badge planned">planned</span>';
  const status = version.status || 'planned';
  const progress = version.progress || 0;
  const label = status === 'complete' ? 'done' : status === 'in-progress' ? `${progress}%` : 'planned';
  return `
    <span class="progress-badge ${status}">
      <span class="progress-bar"><span class="progress-bar-fill ${status}" style="width:${progress}%"></span></span>
      ${label}
    </span>
  `;
}

function getBestVersion(node) {
  const vers = node.versions || {};
  return vers.v2 || vers.v1 || vers.mvp || null;
}

function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

const _mdCache = new Map();
function renderMarkdown(s) {
  if (!s) return '';
  const cached = _mdCache.get(s);
  if (cached !== undefined) return cached;
  try {
    const raw = marked.parse(s, { breaks: true, gfm: true, async: false });
    const clean = DOMPurify.sanitize(raw, {
      ALLOWED_TAGS: ['p','br','strong','em','b','i','ul','ol','li','code','pre',
                     'blockquote','h1','h2','h3','h4','h5','h6','a','hr','del','table',
                     'thead','tbody','tr','th','td'],
      ALLOWED_ATTR: ['href','target','rel']
    });
    _mdCache.set(s, clean);
    return clean;
  } catch { return escapeHtml(s); }
}
DOMPurify.addHook('afterSanitizeAttributes', function (node) {
  if (node.tagName === 'A') {
    node.setAttribute('rel', 'noopener noreferrer');
    node.setAttribute('target', '_blank');
  }
});

// ─── Progression Tree (Cytoscape.js) ─────────────────────
let cy = null;

// Helper functions for position persistence (defined before renderProgressionTree)
async function loadComponentPositions() {
  try {
    const response = await fetch('/api/component-positions');
    if (response.ok) {
      return await response.json();
    }
  } catch (error) {
    console.error('Error loading positions:', error);
  }
  return [];
}

async function saveComponentPosition(componentId, x, y) {
  try {
    // Clamp coordinates to reasonable bounds
    const clampedX = Math.max(0, Math.min(x, 5000));
    const clampedY = Math.max(0, Math.min(y, 5000));

    const response = await fetch('/api/component-positions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ componentId, x: clampedX, y: clampedY })
    });

    if (!response.ok) {
      console.error('Error saving position:', await response.text());
    }
  } catch (error) {
    console.error('Error saving position:', error);
  }
}

async function renderProgressionTree() {
  if (!DATA || !DATA.progression_tree) return;

  // Load saved positions BEFORE creating Cytoscape so they can be
  // applied synchronously in the layoutstop callback.
  const savedPositions = await loadComponentPositions();

  const tree = DATA.progression_tree;
  const elements = [];

  // Color map for visual states
  const stateColors = {
    'locked': { bg: '#1a1d28', border: '#383d50', text: '#5a5f75' },
    'in-progress': { bg: '#1a2520', border: '#fbbf24', text: '#fbbf24' },
    'complete': { bg: '#0f2a1a', border: '#34d399', text: '#34d399' }
  };

  // Compute visual state from display_state
  function visualState(node) {
    if (!node.current_version) return 'locked';
    const major = parseInt(node.current_version.split('.')[0], 10);
    if (isNaN(major) || major < 1) return 'in-progress';
    return 'complete';
  }

  // Add nodes
  for (const node of tree.nodes) {
    const vs = visualState(node);
    const colors = stateColors[vs];
    const versionLabel = node.display_state + (node.current_version ? ' ' + node.current_version : '');

    elements.push({
      data: {
        id: node.id,
        label: (node.icon || '') + ' ' + node.name,
        stateLabel: versionLabel,
        description: node.description || '',
        bgColor: colors.bg,
        borderColor: colors.border,
        textColor: colors.text,
        visualState: vs,
        nodeType: node.type || 'app',
        nodeData: node,
      }
    });
  }

  // Add edges
  for (const edge of tree.edges) {
    elements.push({
      data: {
        id: edge.source_id + '->' + edge.target_id,
        source: edge.source_id,
        target: edge.target_id,
        label: edge.label || '',
      }
    });
  }

  cy = cytoscape({
    container: document.getElementById('progression-container'),
    elements: elements,
    style: [
      {
        selector: 'node',
        style: {
          'label': 'data(label)',
          'text-valign': 'center',
          'text-halign': 'center',
          'font-family': "'JetBrains Mono', monospace",
          'font-size': '11px',
          'font-weight': 600,
          'color': 'data(textColor)',
          'text-wrap': 'wrap',
          'text-max-width': '120px',
          'background-color': 'data(bgColor)',
          'border-color': 'data(borderColor)',
          'border-width': 2,
          'width': 130,
          'height': 130,
          'shape': 'hexagon', /* default; overridden per node type below */
          'text-margin-y': 0,
          'padding': '10px',
        }
      },
      {
        selector: 'node[nodeType="app"]',
        style: {
          'shape': 'octagon',
        }
      },
      {
        selector: 'node[nodeType="mcp"]',
        style: {
          'shape': 'ellipse',
        }
      },
      {
        selector: 'node[visualState="locked"]',
        style: {
          'opacity': 0.5,
          'border-style': 'dashed',
        }
      },
      {
        selector: 'node[visualState="in-progress"]',
        style: {
          'border-width': 2.5,
        }
      },
      {
        selector: 'node[visualState="complete"]',
        style: {
          'border-width': 3,
        }
      },
      {
        selector: 'edge',
        style: {
          'width': 1.5,
          'line-color': '#383d50',
          'target-arrow-color': '#383d50',
          'target-arrow-shape': 'triangle',
          'curve-style': 'bezier',
          'arrow-scale': 0.8,
        }
      }
    ],
    layout: {
      name: 'dagre',
      rankDir: 'TB',
      nodeSep: 50,
      rankSep: 70,
      padding: 30,
    },
    userZoomingEnabled: false,
    userPanningEnabled: false,
    boxSelectionEnabled: false,
    autoungrabify: false,
  });

  // Drag event handlers
  cy.on('grab', 'node', function(e) {
    const node = e.target;
    node.addClass('grabbing');
    document.body.style.cursor = 'grabbing';
  });

  cy.on('free', 'node', function(e) {
    const node = e.target;
    node.removeClass('grabbing');
    document.body.style.cursor = 'default';
    
    // Save the new position
    const position = node.position();
    const nodeId = node.id();
    saveComponentPosition(nodeId, position.x, position.y);
  });

  // Hover effects
  cy.on('mouseover', 'node', function(e) {
    if (!e.target.hasClass('grabbing')) {
      e.target.addClass('grab');
      document.body.style.cursor = 'grab';
    }
  });

  cy.on('mouseout', 'node', function(e) {
    e.target.removeClass('grab');
    if (!e.target.hasClass('grabbing')) {
      document.body.style.cursor = 'default';
    }
  });

  // Apply saved positions after dagre layout completes, then fit
  cy.on('layoutstop', function() {
    if (savedPositions && savedPositions.length > 0) {
      savedPositions.forEach(function(pos) {
        const node = cy.getElementById(pos.componentId);
        if (node.length > 0) {
          node.position({ x: pos.x, y: pos.y });
        }
      });
    }
    cy.fit();
  });

  // Click node to open detail dialog
  cy.on('tap', 'node', function(e) {
    const nodeData = e.target.data('nodeData');
    if (nodeData) openDialog(nodeData.id);
  });

}

// ─── Component Dialog ─────────────────────────────────────
let dialogNodeId = null;
let dialogVersion = null;
let dialogFeaturesOpen = false;

function openDialog(nodeId) {
  const node = getNodeById(nodeId);
  if (!node) return;

  dialogNodeId = nodeId;
  dialogVersion = dialogVersion && (node.versions || {})[dialogVersion] ? dialogVersion : 'mvp';
  dialogFeaturesOpen = false;

  renderDialog();

  document.getElementById('dialog-overlay').classList.add('open');
}

function closeDialog() {
  document.getElementById('dialog-overlay').classList.remove('open');
  dialogNodeId = null;
  dialogVersion = null;
  dialogFeaturesOpen = false;
}

function onOverlayClick(event) {
  if (event.target === document.getElementById('dialog-overlay')) {
    closeDialog();
  }
}

function setDialogVersion(version, event) {
  if (event) event.stopPropagation();
  dialogVersion = version;
  renderDialog();
}

function toggleDialogFeatures(event) {
  if (event) event.stopPropagation();
  dialogFeaturesOpen = !dialogFeaturesOpen;
  renderDialog();
}

function renderDialog() {
  const node = getNodeById(dialogNodeId);
  if (!node) return;

  const vs = node.display_state || 'Concept';
  const stateClass = vs === 'Concept' ? 'state-concept' : vs === 'MVP' ? 'state-mvp' : 'state-released';
  const stateLabel = vs + (node.current_version ? ' ' + node.current_version : '');

  document.getElementById('dialog-header').innerHTML = `
    <div class="dialog-title" style="color:var(--${node.color || 'blue'})">
      <span>${node.icon || '?'}</span>
      ${escapeHtml(node.name)}
      ${renderProgressBadge(getBestVersion(node))}
    </div>
    <div class="dialog-state ${stateClass}">${escapeHtml(stateLabel)}</div>
    <div class="dialog-desc md-content">${renderMarkdown(node.description || '')}</div>
  `;

  // Version strip
  const versions = ['mvp','v1','v2'];
  const stripHtml = `<div class="version-strip">${versions.map(v => {
    const ver = (node.versions || {})[v];
    if (!ver) return '';
    const status = ver.status || 'planned';
    const isActive = dialogVersion === v;
    return `<button class="version-btn ${isActive ? 'active status-'+status : ''}" onclick="setDialogVersion('${v}',event)">${v}${ver.progress > 0 ? ' '+ver.progress+'%' : ''}</button>`;
  }).join('')}</div>`;

  // Version content
  const activeVer = (node.versions || {})[dialogVersion];
  let contentHtml = '';
  if (activeVer) {
    contentHtml = `<div class="version-content md-content">${renderMarkdown(activeVer.content || 'No content yet.')}</div>`;
  }

  // Feature files
  const features = (node.features || {})[dialogVersion];
  let featuresHtml = '';
  if (features && features.length > 0) {
    featuresHtml = `
      <div class="features-section">
        <div class="features-header" onclick="toggleDialogFeatures(event)">
          <span class="arrow ${dialogFeaturesOpen ? 'open' : ''}">▶</span>
          ${features.length} feature file${features.length > 1 ? 's' : ''}
        </div>
        ${dialogFeaturesOpen ? features.map(f => `
          <div class="feature-file">
            <div class="ff-title">${escapeHtml(f.title)}</div>
            <pre>${escapeHtml(f.content)}</pre>
          </div>
        `).join('') : ''}
      </div>
    `;
  }

  document.getElementById('dialog-body').innerHTML = stripHtml + contentHtml + featuresHtml;
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeDialog();
});

// ─── Load Data ───────────────────────────────────────────
async function init() {
  try {
    const resp = await fetch('/api/architecture');
    if (!resp.ok) throw new Error(`API returned ${resp.status}`);
    DATA = await resp.json();
    renderProgressionTree();
  } catch (e) {
    document.getElementById('progression-container').innerHTML =
      '<p style="color:var(--red);text-align:center;margin-top:40px;">Failed to load architecture data from API</p>';
  }
}

init();
</script>
</body>
</html>
