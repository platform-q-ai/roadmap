<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Living View — Open Autonomous Runtime</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/cytoscape@3.30.4/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
<script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
<style>
:root {
  --bg:#07080c;--surface:#0f1219;--surface-2:#171b25;--border:#262c3c;--border-accent:#384058;
  --text:#dfe2ea;--text-dim:#7a8099;--text-muted:#4a5068;
  --blue:#4d8bff;--cyan:#22d3ee;--green:#34d399;--amber:#fbbf24;--red:#f87171;
  --purple:#a78bfa;--pink:#f472b6;--orange:#fb923c;--lime:#a3e635;--teal:#2dd4bf;
  --sky:#38bdf8;--gold:#e8b931;--indigo:#818cf8;--rose:#fb7185;--emerald:#10b981;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;}
.canvas{max-width:1440px;margin:0 auto;padding:36px 22px 80px;}

/* ─── Header ──────────────────────────────────────────── */
.header{text-align:center;margin-bottom:32px;}
.badge{display:inline-block;font-family:'JetBrains Mono',monospace;font-size:10.5px;font-weight:600;text-transform:uppercase;letter-spacing:1.8px;padding:4px 13px;border-radius:3px;margin-bottom:10px;color:var(--gold);border:1px solid rgba(232,185,49,0.35);background:rgba(232,185,49,0.06);}
.header h1{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:27px;letter-spacing:-0.5px;margin-bottom:7px;}
.header h1 .hl{color:var(--cyan);}
.header h1 .v{color:var(--gold);font-size:17.5px;}
.header p{font-size:15px;color:var(--text-dim);max-width:840px;margin:0 auto;line-height:1.65;}
.tags-row{margin-top:10px;display:flex;justify-content:center;gap:5px;flex-wrap:wrap;}
.ch{font-family:'JetBrains Mono',monospace;font-size:10px;padding:2px 7px;border-radius:3px;font-weight:500;}
.ch.new{background:rgba(232,185,49,0.1);color:var(--gold);border:1px solid rgba(232,185,49,0.2);}
.ch.kept{background:rgba(255,255,255,0.02);color:var(--text-muted);border:1px solid rgba(255,255,255,0.05);}

/* ─── Stats Bar ───────────────────────────────────────── */
.stats-bar{display:flex;justify-content:center;gap:24px;margin:20px 0 28px;flex-wrap:wrap;}
.stat{text-align:center;}
.stat .num{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:700;color:var(--cyan);}
.stat .lbl{font-family:'JetBrains Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-muted);margin-top:2px;}

/* ─── Layer ───────────────────────────────────────────── */
.layer{position:relative;border:1px solid var(--border);border-radius:7px;padding:20px 16px 14px;margin-bottom:12px;background:var(--surface);}
.layer::before{content:attr(data-label);position:absolute;top:-9px;left:14px;font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;padding:2px 8px;border-radius:3px;background:var(--bg);z-index:2;}

.l-purple{border-color:rgba(167,139,250,0.3);} .l-purple::before{color:var(--purple);border:1px solid rgba(167,139,250,0.3);}
.l-orange{border-color:rgba(251,146,60,0.35);} .l-orange::before{color:var(--orange);border:1px solid rgba(251,146,60,0.35);}
.l-cyan{border-color:rgba(34,211,238,0.3);} .l-cyan::before{color:var(--cyan);border:1px solid rgba(34,211,238,0.3);}
.l-blue{border-color:rgba(77,139,255,0.3);} .l-blue::before{color:var(--blue);border:1px solid rgba(77,139,255,0.3);}
.l-red{border-color:rgba(248,113,113,0.35);} .l-red::before{color:var(--red);border:1px solid rgba(248,113,113,0.35);}
.l-green{border-color:rgba(52,211,153,0.3);} .l-green::before{color:var(--green);border:1px solid rgba(52,211,153,0.3);}
.l-amber{border-color:rgba(251,191,36,0.3);} .l-amber::before{color:var(--amber);border:1px solid rgba(251,191,36,0.3);}
.l-lime{border-color:rgba(163,230,53,0.25);} .l-lime::before{color:var(--lime);border:1px solid rgba(163,230,53,0.25);}
.l-teal{border-color:rgba(45,212,191,0.3);} .l-teal::before{color:var(--teal);border:1px solid rgba(45,212,191,0.3);}
.l-sky{border-color:rgba(56,189,248,0.3);} .l-sky::before{color:var(--sky);border:1px solid rgba(56,189,248,0.3);}
.l-gold{border-color:rgba(232,185,49,0.35);} .l-gold::before{color:var(--gold);border:1px solid rgba(232,185,49,0.35);}
.l-emerald{border-color:rgba(16,185,129,0.35);} .l-emerald::before{color:var(--emerald);border:1px solid rgba(16,185,129,0.35);}
.l-rose{border-color:rgba(251,113,133,0.3);} .l-rose::before{color:var(--rose);border:1px solid rgba(251,113,133,0.3);}

/* ─── Component Box ───────────────────────────────────── */
.row{display:flex;gap:9px;flex-wrap:wrap;align-items:stretch;}
.row+.row{margin-top:9px;}

.box{flex:1;min-width:130px;background:var(--surface-2);border:1px solid var(--border);border-radius:5px;padding:10px 12px;cursor:pointer;transition:all 0.15s ease;position:relative;}
.box:hover{border-color:var(--border-accent);background:rgba(23,27,37,0.9);}
.box.expanded{background:rgba(23,27,37,0.95);min-width:100%;}

.box .t{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;margin-bottom:3px;display:flex;align-items:center;gap:5px;}
.box .t .ic{width:18px;height:18px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;}
.box .d{font-size:12px;color:var(--text-dim);line-height:1.6;}

.b-blue .t{color:var(--blue);} .b-blue .ic{background:rgba(77,139,255,0.14);} .b-blue{border-color:rgba(77,139,255,0.22);}
.b-cyan .t{color:var(--cyan);} .b-cyan .ic{background:rgba(34,211,238,0.12);} .b-cyan{border-color:rgba(34,211,238,0.18);}
.b-green .t{color:var(--green);} .b-green .ic{background:rgba(52,211,153,0.12);} .b-green{border-color:rgba(52,211,153,0.18);}
.b-amber .t{color:var(--amber);} .b-amber .ic{background:rgba(251,191,36,0.12);} .b-amber{border-color:rgba(251,191,36,0.18);}
.b-red .t{color:var(--red);} .b-red .ic{background:rgba(248,113,113,0.12);} .b-red{border-color:rgba(248,113,113,0.18);}
.b-purple .t{color:var(--purple);} .b-purple .ic{background:rgba(167,139,250,0.12);} .b-purple{border-color:rgba(167,139,250,0.18);}
.b-pink .t{color:var(--pink);} .b-pink .ic{background:rgba(244,114,182,0.12);} .b-pink{border-color:rgba(244,114,182,0.18);}
.b-orange .t{color:var(--orange);} .b-orange .ic{background:rgba(251,146,60,0.12);} .b-orange{border-color:rgba(251,146,60,0.22);}
.b-lime .t{color:var(--lime);} .b-lime .ic{background:rgba(163,230,53,0.1);} .b-lime{border-color:rgba(163,230,53,0.18);}
.b-teal .t{color:var(--teal);} .b-teal .ic{background:rgba(45,212,191,0.1);} .b-teal{border-color:rgba(45,212,191,0.18);}
.b-sky .t{color:var(--sky);} .b-sky .ic{background:rgba(56,189,248,0.1);} .b-sky{border-color:rgba(56,189,248,0.18);}
.b-gold .t{color:var(--gold);} .b-gold .ic{background:rgba(232,185,49,0.12);} .b-gold{border-color:rgba(232,185,49,0.25);}
.b-emerald .t{color:var(--emerald);} .b-emerald .ic{background:rgba(16,185,129,0.12);} .b-emerald{border-color:rgba(16,185,129,0.22);}
.b-rose .t{color:var(--rose);} .b-rose .ic{background:rgba(251,113,133,0.12);} .b-rose{border-color:rgba(251,113,133,0.18);}
.b-indigo .t{color:var(--indigo);} .b-indigo .ic{background:rgba(129,140,248,0.12);} .b-indigo{border-color:rgba(129,140,248,0.18);}

/* ─── Tags ────────────────────────────────────────────── */
.tag-row{display:flex;flex-wrap:wrap;gap:3px;margin-top:4px;}
.tag{display:inline-block;font-family:'JetBrains Mono',monospace;font-size:9px;padding:1px 5px;border-radius:2px;font-weight:500;}
.tag-default{background:rgba(255,255,255,0.04);color:var(--text-muted);border:1px solid rgba(255,255,255,0.06);}
.tag-new{background:rgba(163,230,53,0.1);color:var(--lime);border:1px solid rgba(163,230,53,0.2);}

/* ─── Version Toggle ──────────────────────────────────── */
.version-strip{display:flex;gap:0;margin-top:8px;border-radius:4px;overflow:hidden;border:1px solid var(--border);width:fit-content;}
.version-btn{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;padding:5px 12px;background:var(--surface);color:var(--text-muted);border:none;cursor:pointer;transition:all 0.12s ease;display:flex;align-items:center;gap:4px;border-right:1px solid var(--border);}
.version-btn:last-child{border-right:none;}
.version-btn:hover{color:var(--text-dim);background:var(--surface-2);}
.version-btn.active{background:var(--cyan);color:var(--bg);cursor:default;}
.version-btn.active.status-planned{background:var(--text-muted);}
.version-btn.active.status-in-progress{background:var(--blue);}
.version-btn.active.status-complete{background:var(--green);}

/* ─── Progress Badge ──────────────────────────────────── */
.progress-badge{display:inline-flex;align-items:center;gap:4px;font-family:'JetBrains Mono',monospace;font-size:9.5px;font-weight:600;padding:2px 6px;border-radius:3px;margin-left:auto;}
.progress-badge.planned{background:rgba(255,255,255,0.04);color:var(--text-muted);border:1px solid rgba(255,255,255,0.06);}
.progress-badge.in-progress{background:rgba(77,139,255,0.1);color:var(--blue);border:1px solid rgba(77,139,255,0.2);}
.progress-badge.complete{background:rgba(52,211,153,0.1);color:var(--green);border:1px solid rgba(52,211,153,0.2);}

.progress-bar{width:48px;height:4px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden;}
.progress-bar-fill{height:100%;border-radius:2px;transition:width 0.3s ease;}
.progress-bar-fill.planned{background:var(--text-muted);}
.progress-bar-fill.in-progress{background:var(--blue);}
.progress-bar-fill.complete{background:var(--green);}

/* ─── Expanded Content ────────────────────────────────── */
.version-content{margin-top:8px;padding:10px 12px;background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:4px;font-size:12px;color:var(--text-dim);line-height:1.7;}
.version-content p{margin-bottom:6px;}

/* ─── Feature Files ───────────────────────────────────── */
.features-section{margin-top:8px;}
.features-header{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-muted);margin-bottom:4px;cursor:pointer;display:flex;align-items:center;gap:4px;}
.features-header:hover{color:var(--text-dim);}
.features-header .arrow{transition:transform 0.15s ease;font-size:9px;}
.features-header .arrow.open{transform:rotate(90deg);}
.feature-file{background:rgba(0,0,0,0.25);border:1px solid var(--border);border-radius:4px;padding:8px 10px;margin-top:4px;}
.feature-file .ff-title{font-family:'JetBrains Mono',monospace;font-size:10.5px;font-weight:600;color:var(--teal);margin-bottom:3px;}
.feature-file pre{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);line-height:1.6;white-space:pre-wrap;overflow-x:auto;max-height:300px;overflow-y:auto;}

/* ─── Arrows ──────────────────────────────────────────── */
.arrow{display:flex;align-items:center;justify-content:center;height:16px;margin-bottom:12px;font-family:'JetBrains Mono',monospace;font-size:9.5px;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);}
.arrow .dir{font-size:12.5px;margin-right:4px;}

/* ─── Split Layout ────────────────────────────────────── */
.split{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.split>.layer{margin-bottom:0;}

/* ─── Dual Panel ──────────────────────────────────────── */
.dual-panel{display:grid;grid-template-columns:1fr 1fr;gap:0;margin-bottom:12px;}
.dual-panel .panel{border:1px solid var(--border);border-radius:0;padding:16px 14px 12px;position:relative;background:var(--surface);}
.dual-panel .panel:first-child{border-radius:7px 0 0 7px;border-right:none;}
.dual-panel .panel:last-child{border-radius:0 7px 7px 0;}
.dual-panel .panel::before{content:attr(data-label);position:absolute;top:-9px;left:12px;font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;padding:2px 8px;border-radius:3px;background:var(--bg);z-index:2;}
.panel.p-orange{border-color:rgba(251,146,60,0.35);} .panel.p-orange::before{color:var(--orange);border:1px solid rgba(251,146,60,0.35);}
.panel.p-cyan{border-color:rgba(34,211,238,0.3);} .panel.p-cyan::before{color:var(--cyan);border:1px solid rgba(34,211,238,0.3);}

/* ─── Pipeline ────────────────────────────────────────── */
.pipeline{display:flex;flex-wrap:wrap;align-items:center;gap:3px;margin-top:6px;}
.phase{font-family:'JetBrains Mono',monospace;font-size:9.5px;font-weight:600;padding:4px 9px;border-radius:3px;border:1px solid;cursor:pointer;transition:all 0.12s ease;position:relative;}
.phase:hover{filter:brightness(1.3);}
.phase-arrow{color:var(--text-muted);font-size:10px;}

/* ─── Tabs ────────────────────────────────────────────── */
.tabs{display:flex;gap:0;margin-bottom:24px;border-radius:5px;overflow:hidden;border:1px solid var(--border);width:fit-content;margin-left:auto;margin-right:auto;}
.tab-btn{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px;padding:8px 20px;background:var(--surface);color:var(--text-muted);border:none;cursor:pointer;transition:all 0.15s ease;border-right:1px solid var(--border);}
.tab-btn:last-child{border-right:none;}
.tab-btn:hover{color:var(--text-dim);background:var(--surface-2);}
.tab-btn.active{background:var(--cyan);color:var(--bg);cursor:default;}
.tab-content{display:none;}
.tab-content.active{display:block;}

/* ─── Progression Tree ────────────────────────────────── */
#progression-container{width:100%;height:650px;background:radial-gradient(circle at center, #1a1d28 0%, #07080c 100%);border:1px solid var(--border);border-radius:7px;position:relative;cursor:grab;overflow:hidden;}
#progression-container:active{cursor:grabbing;}

.skill-tree-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;padding:20px;display:flex;flex-direction:column;justify-content:space-between;}
.skill-tree-top{display:flex;justify-content:space-between;align-items:flex-start;}
.skill-tree-center-top{text-align:center;position:absolute;top:20px;left:50%;transform:translateX(-50%);}
.skill-tree-bottom{display:flex;justify-content:center;padding-bottom:10px;}

.skill-branch-label{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;display:flex;flex-direction:column;align-items:center;gap:5px;}
.skill-branch-label .count{width:32px;height:32px;border:2px solid var(--border-accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--gold);background:rgba(232,185,49,0.05);}

.skill-sync{text-align:left;}
.skill-sync .title{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;color:var(--gold);letter-spacing:1px;margin-bottom:2px;}
.skill-sync .sub{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-muted);letter-spacing:1px;}

.skill-points{text-align:center;}
.skill-points .num{font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700;color:var(--text);line-height:1;}
.skill-points .lbl{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--gold);letter-spacing:2px;margin-top:4px;text-transform:uppercase;}

.skill-level-bar{width:200px;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;margin:8px auto 0;position:relative;overflow:hidden;}
.skill-level-fill{height:100%;background:var(--gold);border-radius:2px;transition:width 0.5s ease;}
.state-concept{color:var(--text-muted);}
.state-mvp{color:var(--amber);}
.state-released{color:var(--green);}

/* ─── Component Dialog ────────────────────────────────── */
.dialog-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.dialog-overlay.open{display:flex;}
.dialog-box{background:var(--surface);border:1px solid var(--border-accent);border-radius:8px;width:90%;max-width:640px;max-height:80vh;overflow-y:auto;padding:24px 28px;position:relative;box-shadow:0 20px 60px rgba(0,0,0,0.5);}
.dialog-close{position:absolute;top:12px;right:14px;background:none;border:1px solid var(--border);border-radius:4px;color:var(--text-dim);font-size:14px;cursor:pointer;width:28px;height:28px;display:flex;align-items:center;justify-content:center;transition:all 0.12s ease;}
.dialog-close:hover{color:var(--text);border-color:var(--border-accent);background:var(--surface-2);}
.dialog-header{margin-bottom:12px;}
.dialog-header .dialog-title{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:18px;display:flex;align-items:center;gap:8px;padding-right:40px;}
.dialog-header .dialog-state{font-family:'JetBrains Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:0.8px;margin-top:4px;}
.dialog-header .dialog-desc{font-size:13px;color:var(--text-dim);line-height:1.6;margin-top:8px;}
.dialog-body{margin-top:12px;}

/* ─── Responsive ──────────────────────────────────────── */
@media(max-width:900px){
  .row,.split,.dual-panel{display:flex;flex-direction:column;}
  .canvas{padding:18px 12px 60px;}
  .dual-panel .panel{border-radius:7px!important;border:1px solid var(--border)!important;margin-bottom:10px;}
  .stats-bar{gap:14px;}
}
</style>
</head>
<body>
<div class="canvas" id="app">
  <div class="header">
    <div class="badge">Living Documentation</div>
    <h1>Open <span class="hl">Autonomous Runtime</span> <span class="v">v3.2</span></h1>
    <p>Living architecture documentation. Each component has versioned specs (Overview → MVP → v1 → v2) with Gherkin feature files. Click any component to explore its documentation and build progress.</p>
    <div class="tags-row">
      <span class="ch new">interactive</span>
      <span class="ch new">versioned specs</span>
      <span class="ch new">gherkin features</span>
      <span class="ch kept">sqlite graph</span>
      <span class="ch kept">build in the open</span>
    </div>
  </div>

  <div class="stats-bar" id="stats-bar"></div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('progression')">Progression</button>
    <button class="tab-btn" onclick="switchTab('architecture')">Architecture</button>
  </div>

  <div id="tab-progression" class="tab-content active">
    <div id="progression-container">
      <div class="skill-tree-overlay">
        <div class="skill-tree-top">
          <div class="skill-sync">
            <div class="title" id="sync-title">SENU'S PERCEPTIE</div>
            <div class="sub" id="sync-status">0/0 GESYNCHRONISEERD</div>
          </div>
          <div class="skill-branch-label" style="position:absolute;left:10%;top:150px;">
            <div class="count" id="count-jager">1</div>
            <div>JAGER</div>
          </div>
          <div class="skill-branch-label" style="position:absolute;right:10%;top:150px;">
            <div class="count" id="count-ziener">1</div>
            <div>ZIENER</div>
          </div>
        </div>
        <div class="skill-tree-center-top">
          <div class="skill-branch-label">
            <div>KRIJGER</div>
            <div class="count" id="count-krijger">1</div>
          </div>
        </div>
        <div class="skill-tree-bottom">
          <div class="skill-points">
            <div class="num" id="total-skill-points">23</div>
            <div class="lbl">VAARDIGHEIDSPUNTEN</div>
            <div class="skill-level-bar"><div class="skill-level-fill" id="sync-bar-fill" style="width:0%"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-architecture" class="tab-content">
    <div id="architecture"></div>
  </div>
</div>

<div class="dialog-overlay" id="dialog-overlay" onclick="onOverlayClick(event)">
  <div class="dialog-box" id="dialog-box">
    <button class="dialog-close" onclick="closeDialog()">&times;</button>
    <div class="dialog-header" id="dialog-header"></div>
    <div class="dialog-body" id="dialog-body"></div>
  </div>
</div>

<script>
// ─── Color Helpers ───────────────────────────────────────
const COLORS = {
  sky:'#38bdf8',purple:'#a78bfa',lime:'#a3e635',gold:'#e8b931',orange:'#fb923c',
  cyan:'#22d3ee',blue:'#4d8bff',red:'#f87171',amber:'#fbbf24',teal:'#2dd4bf',
  green:'#34d399',emerald:'#10b981',rose:'#fb7185',pink:'#f472b6',indigo:'#818cf8'
};

const PHASE_COLORS = {
  'phase-feature':'gold','phase-steps':'cyan','phase-units':'purple','phase-red':'red',
  'phase-green':'green','phase-refactor':'sky','phase-arch-review':'orange','phase-sec-review':'rose'
};

// ─── State ───────────────────────────────────────────────
let DATA = null;
let expandedNodes = {};    // nodeId → active version
let expandedFeatures = {}; // nodeId → bool

// ─── Render ──────────────────────────────────────────────
function renderStats() {
  const el = document.getElementById('stats-bar');
  if (!DATA) return;
  const s = DATA.stats;

  // Calculate overall progress
  const allVersions = DATA.nodes.flatMap(n => Object.values(n.versions || {}));
  const totalProgress = allVersions.length > 0
    ? Math.round(allVersions.reduce((sum, v) => sum + (v.progress || 0), 0) / allVersions.length)
    : 0;

  el.innerHTML = `
    <div class="stat"><div class="num">${s.total_nodes}</div><div class="lbl">Components</div></div>
    <div class="stat"><div class="num">${s.total_edges}</div><div class="lbl">Relationships</div></div>
    <div class="stat"><div class="num">${s.total_versions}</div><div class="lbl">Version Specs</div></div>
    <div class="stat"><div class="num">${s.total_features}</div><div class="lbl">Feature Files</div></div>
    <div class="stat"><div class="num">${totalProgress}%</div><div class="lbl">Overall</div></div>
  `;
}

function getNodeById(id) {
  return DATA.nodes.find(n => n.id === id);
}

function renderProgressBadge(version) {
  if (!version) return '<span class="progress-badge planned">planned</span>';
  const status = version.status || 'planned';
  const progress = version.progress || 0;
  const label = status === 'complete' ? 'done' : status === 'in-progress' ? `${progress}%` : 'planned';
  return `
    <span class="progress-badge ${status}">
      <span class="progress-bar"><span class="progress-bar-fill ${status}" style="width:${progress}%"></span></span>
      ${label}
    </span>
  `;
}

function renderVersionStrip(node) {
  const versions = ['mvp','v1','v2'];
  const active = expandedNodes[node.id] || null;

  return `<div class="version-strip">${versions.map(v => {
    const ver = (node.versions || {})[v];
    if (!ver) return '';
    const status = ver.status || 'planned';
    const isActive = active === v;
    return `<button class="version-btn ${isActive ? 'active status-'+status : ''}" onclick="toggleVersion('${node.id}','${v}',event)">${v}${ver.progress > 0 ? ' '+ver.progress+'%' : ''}</button>`;
  }).join('')}</div>`;
}

function renderVersionContent(node) {
  const active = expandedNodes[node.id];
  if (!active) return '';
  const ver = (node.versions || {})[active];
  if (!ver) return '';

  let html = `<div class="version-content"><p>${escapeHtml(ver.content || 'No content yet.')}</p></div>`;

  // Feature files for this version
  const features = (node.features || {})[active];
  if (features && features.length > 0) {
    const isOpen = expandedFeatures[node.id];
    html += `
      <div class="features-section">
        <div class="features-header" onclick="toggleFeatures('${node.id}',event)">
          <span class="arrow ${isOpen ? 'open' : ''}">▶</span>
          ${features.length} feature file${features.length > 1 ? 's' : ''}
        </div>
        ${isOpen ? features.map(f => `
          <div class="feature-file">
            <div class="ff-title">${escapeHtml(f.title)}</div>
            <pre>${escapeHtml(f.content)}</pre>
          </div>
        `).join('') : ''}
      </div>
    `;
  }

  return html;
}

function renderTags(node) {
  let tags = [];
  try { tags = typeof node.tags === 'string' ? JSON.parse(node.tags) : (node.tags || []); } catch(e) {}
  if (!tags || tags.length === 0) return '';
  return `<div class="tag-row">${tags.map(t =>
    `<span class="tag ${t === 'new' ? 'tag-new' : 'tag-default'}">${escapeHtml(t)}</span>`
  ).join('')}</div>`;
}

function renderVersionBadge(node) {
  if (!node.display_state || node.display_state === 'Concept') return '';
  const cls = node.display_state === 'MVP' ? 'state-mvp' : 'state-released';
  const label = node.display_state + (node.current_version ? ' ' + node.current_version : '');
  return `<span class="progress-badge in-progress" style="margin-left:6px;font-size:9px;">${escapeHtml(label)}</span>`;
}

function renderBox(node, extraClass) {
  const c = node.color || 'blue';
  const isExpanded = expandedNodes[node.id];

  return `
    <div class="box b-${c} ${isExpanded ? 'expanded' : ''} ${extraClass || ''}" id="box-${node.id}">
      <div class="t" onclick="toggleVersion('${node.id}','mvp',event)">
        <span class="ic">${node.icon || '?'}</span>
        ${escapeHtml(node.name)}
        ${renderVersionBadge(node)}
        ${renderProgressBadge(getBestVersion(node))}
      </div>
      <div class="d">${escapeHtml(getOverviewText(node))}</div>
      ${!isExpanded ? renderTags(node) : ''}
      ${isExpanded ? renderVersionStrip(node) : ''}
      ${isExpanded ? renderVersionContent(node) : ''}
    </div>
  `;
}

function getBestVersion(node) {
  const vers = node.versions || {};
  return vers.v2 || vers.v1 || vers.mvp || null;
}

function getOverviewText(node) {
  const vers = node.versions || {};
  if (vers.overview) return vers.overview.content || node.description || '';
  return node.description || '';
}

function renderLayer(layer) {
  const c = layer.color || 'blue';
  const children = layer.children || [];

  // Special rendering for certain layers
  if (layer.id === 'dual-agents') return renderDualAgents(layer);
  if (layer.id === 'bdd-tdd-pipeline') return renderPipeline(layer);
  if (layer.id === 'knowledge-graphs') return renderSplit(layer);
  if (layer.id === 'mcp-proxies') return renderSplit(layer);

  // Description-only layers (no children)
  if (children.length === 0) {
    return `
      <div class="layer l-${c}" data-label="${escapeHtml(layer.name)}" style="padding:16px 16px 14px;">
        <div class="row">
          <div class="box b-${c}" style="min-width:100%;cursor:default;">
            <div class="t"><span class="ic">${layer.icon || '?'}</span> ${escapeHtml(layer.name)}</div>
            <div class="d">${escapeHtml(layer.description || '')}</div>
          </div>
        </div>
      </div>
    `;
  }

  // Group children into rows of up to 4
  const rows = [];
  for (let i = 0; i < children.length; i += 4) {
    rows.push(children.slice(i, i + 4));
  }

  return `
    <div class="layer l-${c}" data-label="${escapeHtml(layer.name)}">
      ${rows.map(row => `<div class="row">${row.map(ch => renderBox(ch)).join('')}</div>`).join('')}
    </div>
  `;
}

function renderSplit(layer) {
  const c = layer.color || 'blue';
  const children = layer.children || [];
  if (children.length < 2) return renderLayer(layer);

  return `
    <div class="split">
      ${children.map(ch => `
        <div class="layer l-${ch.color || c}" data-label="${escapeHtml(ch.name)}">
          <div class="row">${renderBox(ch, 'min-w-full')}</div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderDualAgents(layer) {
  const meta = layer.children.find(c => c.id === 'meta-agent');
  const worker = layer.children.find(c => c.id === 'worker');
  const metaTools = layer.children.filter(c =>
    ['goal-queue','state-reader','worker-control','proxy-admin','config-mutator','tool-registry',
     'user-kg-read-meta','user-kg-write-meta','code-graph-read-meta','code-graph-write-meta'].includes(c.id)
  );
  const workerTools = layer.children.filter(c =>
    ['request-clarification','check-escalation-response','user-kg-read-worker','code-graph-read-worker'].includes(c.id)
  );

  return `
    <div class="dual-panel">
      <div class="panel p-orange" data-label="Meta-Agent (Planner)">
        ${meta ? renderBox(meta, 'min-w-full') : ''}
        <div style="margin-top:8px;">
          <div class="row">${metaTools.slice(0,3).map(t => renderBox(t)).join('')}</div>
          <div class="row">${metaTools.slice(3,6).map(t => renderBox(t)).join('')}</div>
          <div class="row">${metaTools.slice(6).map(t => renderBox(t)).join('')}</div>
        </div>
      </div>
      <div class="panel p-cyan" data-label="Worker (Executor)">
        ${worker ? renderBox(worker, 'min-w-full') : ''}
        <div style="margin-top:8px;">
          <div class="row">${workerTools.map(t => renderBox(t)).join('')}</div>
        </div>
      </div>
    </div>
  `;
}

function renderPipeline(layer) {
  const c = layer.color || 'teal';
  const phases = layer.children || [];
  const phaseOrder = ['phase-feature','phase-steps','phase-units','phase-red','phase-green','phase-refactor','phase-arch-review','phase-sec-review'];
  const sorted = phaseOrder.map(id => phases.find(p => p.id === id)).filter(Boolean);

  return `
    <div class="layer l-${c}" data-label="${escapeHtml(layer.name)} · per coding task">
      <div class="pipeline">
        ${sorted.map((p, i) => {
          const pc = PHASE_COLORS[p.id] || 'teal';
          const isExpanded = expandedNodes[p.id];
          return `
            ${i > 0 ? '<span class="phase-arrow">→</span>' : ''}
            <span class="phase"
                  onclick="toggleVersion('${p.id}','mvp',event)"
                  style="color:${COLORS[pc]};border-color:${COLORS[pc]}33;background:${COLORS[pc]}0f;">${escapeHtml(p.name)}</span>
          `;
        }).join('')}
      </div>
      ${sorted.filter(p => expandedNodes[p.id]).map(p => `
        <div style="margin-top:8px;">
          ${renderBox(p, 'min-w-full')}
        </div>
      `).join('')}
    </div>
  `;
}

function renderArrow(text) {
  return `<div class="arrow"><span class="dir">▼</span> ${escapeHtml(text)}</div>`;
}

function render() {
  if (!DATA) return;

  renderStats();

  const el = document.getElementById('architecture');
  const layerOrder = [
    'observability-dashboard',
    null, // arrow
    'supervisor-layer',
    null,
    'task-router-layer',
    null,
    'knowledge-graphs',
    null,
    'dual-agents',
    null,
    'escalation-flow',
    null,
    'shared-state',
    null,
    'mcp-proxies',
    null,
    'security-sandbox',
    null,
    'downstream-tools',
    null,
    'bdd-tdd-pipeline'
  ];

  const arrowLabels = [
    'reads from all stores + supervisor api',
    'spawns and manages both instances',
    'routes to appropriate instance',
    'both agents access graphs via mcp tools',
    'communicate via shared state',
    'both instances read/write state store',
    'proxies connect each instance to its tools',
    'worker proxy only',
    'worker proxy fans out to downstream',
    'enforced by meta-agent, executed by worker'
  ];

  let arrowIdx = 0;
  let html = '';

  for (const item of layerOrder) {
    if (item === null) {
      html += renderArrow(arrowLabels[arrowIdx++] || '');
    } else {
      const layer = DATA.layers.find(l => l.id === item);
      if (layer) html += renderLayer(layer);
    }
  }

  el.innerHTML = html;
}

// ─── Interactions ────────────────────────────────────────
function toggleVersion(nodeId, version, event) {
  if (event) event.stopPropagation();

  if (expandedNodes[nodeId] === version) {
    delete expandedNodes[nodeId];
    delete expandedFeatures[nodeId];
  } else {
    expandedNodes[nodeId] = version;
  }
  render();
}

function toggleFeatures(nodeId, event) {
  if (event) event.stopPropagation();
  expandedFeatures[nodeId] = !expandedFeatures[nodeId];
  render();
}

function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─── Tab Switching ───────────────────────────────────────
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  document.querySelector('[onclick="switchTab(\'' + tab + '\')"]').classList.add('active');
  if (tab === 'progression' && DATA && !window._cyInitialized) {
    renderProgressionTree();
  }
}

// ─── Progression Tree (Cytoscape.js) ─────────────────────
let cy = null;

function renderProgressionTree() {
  if (!DATA || !DATA.progression_tree) return;

  const tree = DATA.progression_tree;
  const elements = [];

  // Color map for visual states
  const stateColors = {
    'locked': { bg: '#10121a', border: '#262c3c', text: '#4a5068', glow: 'none' },
    'in-progress': { bg: '#1a1d28', border: '#fbbf24', text: '#fbbf24', glow: '0 0 15px rgba(251,191,36,0.3)' },
    'complete': { bg: '#0f2a1a', border: '#34d399', text: '#34d399', glow: '0 0 20px rgba(52,211,153,0.4)' }
  };

  // Compute visual state from display_state
  function visualState(node) {
    if (!node.current_version) return 'locked';
    const major = parseInt(node.current_version.split('.')[0], 10);
    if (isNaN(major) || major < 1) return 'in-progress';
    return 'complete';
  }

  // Branch mapping (skill categories)
  const JAGER_LAYERS = ['dual-agents', 'mcp-proxies', 'security-sandbox', 'downstream-tools', 'bdd-tdd-pipeline'];
  const ZIENER_LAYERS = ['observability-dashboard'];
  const KRIJGER_LAYERS = ['supervisor-layer', 'task-router-layer', 'shared-state', 'knowledge-graphs'];

  let jagerCount = 0, zienerCount = 0, krijgerCount = 0;
  let completeCount = 0;

  // Enumerate nodes for tree elements
  for (const node of tree.nodes) {
    const vs = visualState(node);
    const colors = stateColors[vs];
    if (vs === 'complete') completeCount++;

    // Assign branch for UI counters
    if (JAGER_LAYERS.includes(node.layer)) jagerCount++;
    else if (ZIENER_LAYERS.includes(node.layer)) zienerCount++;
    else krijgerCount++;

    elements.push({
      data: {
        id: node.id,
        label: node.icon || '?',
        name: node.name,
        bgColor: colors.bg,
        borderColor: colors.border,
        textColor: colors.text,
        visualState: vs,
        nodeData: node,
        shadow: colors.glow
      }
    });
  }

  // Update UI Counters
  document.getElementById('count-jager').textContent = jagerCount;
  document.getElementById('count-ziener').textContent = zienerCount;
  document.getElementById('count-krijger').textContent = krijgerCount;
  document.getElementById('total-skill-points').textContent = tree.nodes.length;
  document.getElementById('sync-status').textContent = `${completeCount}/${tree.nodes.length} GESYNCHRONISEERD`;
  const syncPct = tree.nodes.length > 0 ? (completeCount / tree.nodes.length) * 100 : 0; // synchronization percentage
  document.getElementById('sync-bar-fill').style.width = `${syncPct}%`;

  // Add edges
  for (const edge of tree.edges) {
    elements.push({
      data: {
        id: edge.source_id + '->' + edge.target_id,
        source: edge.source_id,
        target: edge.target_id,
      }
    });
  }

  cy = cytoscape({
    container: document.getElementById('progression-container'),
    elements: elements,
    style: [
      {
        selector: 'node',
        style: {
          'label': 'data(label)',
          'text-valign': 'center',
          'text-halign': 'center',
          'font-family': "'JetBrains Mono', monospace",
          'font-size': '24px',
          'color': 'data(textColor)',
          'background-color': 'data(bgColor)',
          'border-color': 'data(borderColor)',
          'border-width': 4,
          'width': 64,
          'height': 64,
          'shape': 'circle',
          'transition-property': 'background-color, border-color',
          'transition-duration': '0.2s',
          'shadow-blur': 15,
          'shadow-color': 'data(textColor)',
          'shadow-opacity': 0.3,
          'shadow-offset-x': 0,
          'shadow-offset-y': 0
        }
      },
      {
        selector: 'node[visualState="locked"]',
        style: {
          'filter': 'grayscale(100%)',
          'opacity': 0.6
        }
      },
      {
        selector: 'edge',
        style: {
          'width': 3,
          'line-color': '#262c3c',
          'curve-style': 'taxi',
          'taxi-direction': 'vertical',
          'taxi-turn': '20px',
          'target-arrow-shape': 'none',
          'source-arrow-shape': 'none'
        }
      }
    ],
    layout: {
      name: 'dagre',
      rankDir: 'BT', // Bottom to top to match skill tree growth
      nodeSep: 80,
      rankSep: 100,
      padding: 50,
    },
    userZoomingEnabled: true,
    userPanningEnabled: true,
    boxSelectionEnabled: false,
    autoungrabify: false,
  });

  cy.on('layoutstop', () => cy.fit());
  window.addEventListener('resize', () => cy && cy.fit());

  cy.on('tap', 'node', function(e) {
    const nodeData = e.target.data('nodeData');
    if (nodeData) openDialog(nodeData.id);
  });

  window._cyInitialized = true;
}

// ─── Component Dialog ─────────────────────────────────────
let dialogNodeId = null;
let dialogVersion = null;
let dialogFeaturesOpen = false;

function openDialog(nodeId) {
  const node = getNodeById(nodeId);
  if (!node) return;

  dialogNodeId = nodeId;
  dialogVersion = dialogVersion && (node.versions || {})[dialogVersion] ? dialogVersion : 'mvp';
  dialogFeaturesOpen = false;

  renderDialog();

  document.getElementById('dialog-overlay').classList.add('open');
}

function closeDialog() {
  document.getElementById('dialog-overlay').classList.remove('open');
  dialogNodeId = null;
  dialogVersion = null;
  dialogFeaturesOpen = false;
}

function onOverlayClick(event) {
  if (event.target === document.getElementById('dialog-overlay')) {
    closeDialog();
  }
}

function setDialogVersion(version, event) {
  if (event) event.stopPropagation();
  dialogVersion = version;
  renderDialog();
}

function toggleDialogFeatures(event) {
  if (event) event.stopPropagation();
  dialogFeaturesOpen = !dialogFeaturesOpen;
  renderDialog();
}

function renderDialog() {
  const node = getNodeById(dialogNodeId);
  if (!node) return;

  const vs = node.display_state || 'Concept';
  const stateClass = vs === 'Concept' ? 'state-concept' : vs === 'MVP' ? 'state-mvp' : 'state-released';
  const stateLabel = vs + (node.current_version ? ' ' + node.current_version : '');

  document.getElementById('dialog-header').innerHTML = `
    <div class="dialog-title" style="color:var(--${node.color || 'blue'})">
      <span>${node.icon || '?'}</span>
      ${escapeHtml(node.name)}
      ${renderProgressBadge(getBestVersion(node))}
    </div>
    <div class="dialog-state ${stateClass}">${escapeHtml(stateLabel)}</div>
    <div class="dialog-desc">${escapeHtml(node.description || '')}</div>
  `;

  // Version strip
  const versions = ['mvp','v1','v2'];
  const stripHtml = `<div class="version-strip">${versions.map(v => {
    const ver = (node.versions || {})[v];
    if (!ver) return '';
    const status = ver.status || 'planned';
    const isActive = dialogVersion === v;
    return `<button class="version-btn ${isActive ? 'active status-'+status : ''}" onclick="setDialogVersion('${v}',event)">${v}${ver.progress > 0 ? ' '+ver.progress+'%' : ''}</button>`;
  }).join('')}</div>`;

  // Version content
  const activeVer = (node.versions || {})[dialogVersion];
  let contentHtml = '';
  if (activeVer) {
    contentHtml = `<div class="version-content"><p>${escapeHtml(activeVer.content || 'No content yet.')}</p></div>`;
  }

  // Feature files
  const features = (node.features || {})[dialogVersion];
  let featuresHtml = '';
  if (features && features.length > 0) {
    featuresHtml = `
      <div class="features-section">
        <div class="features-header" onclick="toggleDialogFeatures(event)">
          <span class="arrow ${dialogFeaturesOpen ? 'open' : ''}">▶</span>
          ${features.length} feature file${features.length > 1 ? 's' : ''}
        </div>
        ${dialogFeaturesOpen ? features.map(f => `
          <div class="feature-file">
            <div class="ff-title">${escapeHtml(f.title)}</div>
            <pre>${escapeHtml(f.content)}</pre>
          </div>
        `).join('') : ''}
      </div>
    `;
  }

  document.getElementById('dialog-body').innerHTML = stripHtml + contentHtml + featuresHtml;
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeDialog();
});

// ─── Load Data ───────────────────────────────────────────
async function init() {
  try {
    const resp = await fetch('/api/architecture');
    if (!resp.ok) throw new Error(`API returned ${resp.status}`);
    DATA = await resp.json();
    render();
    renderProgressionTree();
  } catch (e) {
    document.getElementById('architecture').innerHTML =
      '<p style="color:var(--red);text-align:center;margin-top:40px;">Failed to load architecture data from API</p>';
  }
}

init();
</script>
</body>
</html>
